# Work Log - 2025-10-27

## 작업 개요
모바일 앱 UI 개선, 식수 관리 기능 강화, 구글 플레이 스토어 등록 준비 완료

## 완료된 작업

### 1. 모바일 홈 화면 UI 균형 개선 ✅
**목적**: 출퇴근 권한 유무에 따라 메뉴 개수가 달라지는 문제 해결

#### 문제점
- 출퇴근 권한 있음: 4개 박스 (출퇴근/VOC/배식/고객) → 균형 O
- 출퇴근 권한 없음: 3개 박스 (VOC/배식/고객) → 균형 X

#### 해결 방안
**파일**: `mobile/src/screens/HomeScreen.tsx`

**변경 내용**:
1. 상단에 "오늘의 근무" 큰 카드 섹션 유지 (조건부)
   - 출퇴근 권한자만 표시
   - 큰 버튼으로 노인 분들이 쉽게 확인 가능

2. 하단 메뉴 그리드를 항상 4개로 고정
   - 출퇴근 박스 제거
   - 🍚 식수 관리 박스 추가 (MealCountTab)
   - 📝 VOC 작성
   - 📸 배식 사진
   - 🏢 고객 VOC

**최종 구조**:
```
[출퇴근 권한자]
┌─────────────────────────────┐
│  [사업장 선택]               │
├─────────────────────────────┤
│  오늘의 근무 (큰 카드)       │  ← 출퇴근 기능
│  [출근하기] 큰 버튼          │
├─────────────────────────────┤
│  업무 메뉴                   │
│  ┌────────┬────────┐        │
│  │🍚식수   │📝VOC   │        │
│  ├────────┼────────┤        │
│  │📸배식   │🏢고객  │        │
│  └────────┴────────┘        │
└─────────────────────────────┘

[출퇴근 권한 없는 사용자]
┌─────────────────────────────┐
│  [사업장 선택]               │
├─────────────────────────────┤
│  업무 메뉴                   │
│  ┌────────┬────────┐        │
│  │🍚식수   │📝VOC   │        │
│  ├────────┼────────┤        │
│  │📸배식   │🏢고객  │        │
│  └────────┴────────┘        │
└─────────────────────────────┘
```

**Git Commit**:
- Mobile: `29e00e7` - feat: Redesign home menu grid with balanced 4-box layout
- Main: `1eae2f0` - chore: Update mobile submodule with balanced home menu layout

---

### 2. 식수 관리 기능 강화 ✅

#### 웹 관리자 페이지
**파일**: `web/src/pages/meal-count/MealCountListPage.tsx`

**변경 내용**:
- 날짜 범위 기본값: 월별 (startOf/endOf month)
- 테이블 데이터 역순 정렬 (`.reverse()`)로 최근 날짜가 위로

**효과**:
- 관리자가 최근 데이터를 먼저 확인 가능
- 월별 조회로 전체 현황 파악 용이

#### 모바일 앱
**파일**: `mobile/src/screens/MealCountScreen.tsx`

**주요 변경 (447 insertions, 53 deletions)**:

1. **과거 데이터 표시 추가** (lines 48-58)
   ```typescript
   const getDateRange = () => {
     const dates = [];
     for (let i = -3; i <= 7; i++) {  // 과거 3일 + 오늘 + 미래 7일
       const date = new Date();
       date.setDate(date.getDate() + i);
       dates.push(date);
     }
     return dates;
   };
   ```

2. **월별 조회 모드 추가** (lines 44-45, 62-76)
   - `viewMode` 상태: 'recent' | 'monthly'
   - `selectedMonth` 상태: 월 선택
   - 월별 날짜 생성 함수 (`getMonthlyDates`)

3. **듀얼 쿼리 구조** (lines 108-148)
   - `mealCountsRange`: 최근 11일 조회 (과거 3일~미래 7일)
   - `monthlyMealCounts`: 선택한 월 전체 조회
   - `enabled` 조건으로 viewMode에 따라 분리 실행

4. **필터 UI** (lines 427-476)
   - "최근 조회" / "월별 조회" 토글 버튼
   - 월 네비게이션 (이전달/다음달)
   - 선택한 월 표시 (YYYY년 MM월)

5. **날짜 네비게이션 업데이트** (lines 240-247)
   - 과거 3일까지 이동 가능하도록 제한 완화

**Git Commit**:
- Mobile: `5d0bf0d` - feat: Add past 3 days display and monthly filter to meal count screen
- Main: `a3257a6` - feat: Comprehensive meal count enhancements

---

### 3. 사업장 선택 UI 3단계 계층 구조 ✅
**파일**: `mobile/src/components/SiteSelector.tsx` (256 insertions)

#### 구현된 계층 구조
```
▼ 영남그룹A (15개)
  ▼ 도시락 (12개)
    └─ 영남사업장1
    └─ 영남사업장2
  ▶ 위탁 (3개)

▼ 본사그룹B (8개)
  ▶ 배송 (5개)
  ▼ 행사 (3개)
    └─ 본사행사장1

▼ 미지정 (5개)
  ▶ 도시락 (5개)
```

#### 주요 기능
1. **사업장 유형 한글 변환** (lines 30-44)
   - CONSIGNMENT → 위탁
   - DELIVERY → 배송
   - LUNCHBOX → 도시락
   - EVENT → 행사

2. **3단계 그룹화** (lines 87-136)
   - 1단계: 그룹별 (group.name or "미지정")
   - 2단계: 유형별 (type)
   - 정렬: 가나다순, "미지정" 맨 마지막

3. **아코디언 UI** (lines 216-284)
   - 그룹 헤더: 접기/펼치기, 총 개수
   - 유형 헤더: 들여쓰기, 접기/펼치기, 유형별 개수
   - 사업장 항목: 체크마크, 파란색 하이라이트

#### 백엔드 권한 필터링
**파일**: `backend/src/controllers/site.controller.ts` (lines 32-40)

```typescript
// 권한별 자동 필터링
if (user.role === 'HQ_ADMIN' && !filter.division) {
  filter.division = 'HQ';
} else if (user.role === 'YEONGNAM_ADMIN' && !filter.division) {
  filter.division = 'YEONGNAM';
}
```

**효과**:
- HQ_ADMIN: 본사(HQ) 사업장만 조회
- YEONGNAM_ADMIN: 영남지사(YEONGNAM) 사업장만 조회
- SUPER_ADMIN: 모든 사업장 조회

#### 웹 관리자 자동 Division 설정
**파일**: `web/src/pages/staff/StaffFormPage.tsx` (lines 119-136)

```typescript
const handleRoleChange = (role: string) => {
  setSelectedRole(role);

  // 권한에 따라 자동으로 division 설정
  let division = undefined;
  if (role === 'HQ_ADMIN' || role === 'SITE_MANAGER' || role === 'SITE_STAFF') {
    division = 'HQ';
  } else if (role === 'YEONGNAM_ADMIN') {
    division = 'YEONGNAM';
  }

  form.setFieldsValue({ role, division });
};
```

**효과**:
- 담당자 등록 시 권한 선택하면 자동으로 division 설정
- Division에 맞는 사업장만 배정 가능

---

### 4. 구글 플레이 스토어 등록 준비 ✅

#### 프로덕션 AAB 빌드 완료
- **빌드 ID**: ed7df58f-0d32-479a-a2cf-238b4cd93f61
- **버전**: 1.0.0 (versionCode: 3)
- **다운로드 링크**: https://expo.dev/artifacts/eas/vjWryc9VXv5Hd8KyodKTqe.aab
- **형식**: AAB (Android App Bundle)
- **자동 버전 증가**: 2 → 3

#### 앱 등록 문서 작성
**파일**: `mobile/store_listing.md`

**내용**:
- 앱 이름: 다함 VOC
- 짧은 설명 (80자): 급식 사업장 관리를 위한 VOC 수집 및 출퇴근, 배식 관리 통합 솔루션
- 전체 설명 (4000자): 주요 기능, 특징, 대상
- 권한 설명: 위치(GPS), 카메라, 저장소
- 스크린샷 설명 (5개)
- 연락처: admin@daham.com

#### 등록 가이드 작성
**파일**: `mobile/play_store_guide.md`

**내용**:
- 구글 플레이 콘솔 계정 생성 방법
- 앱 만들기 단계별 가이드
- 스토어 등록정보 작성 템플릿
- 그래픽 자산 요구사항
- 앱 콘텐츠 설정 (연령, 개인정보, 보안)
- AAB 업로드 방법
- 검토 및 게시 체크리스트

---

## 기술 스택

### Backend
- Prisma ORM + PostgreSQL (Supabase)
- Node.js + Express

### Web Frontend
- React + TypeScript
- Vite
- Ant Design
- React Query

### Mobile
- React Native + Expo
- TypeScript
- React Query
- Zustand (상태 관리)
- EAS Build (배포)

---

## 다음 세션 계획

### ⚠️ 우선순위 1: 구글 플레이 스토어 등록 (필수)

#### 1. 개인정보처리방침 페이지 생성 (1-2시간)
- URL: https://dahamvoc.co.kr/privacy
- 수집 정보, 사용 목적, 보관 기간 명시

#### 2. 스크린샷 캡처 (30분)
- 홈 화면
- 식수 관리
- VOC 작성
- 배식 사진
- 출퇴근

#### 3. 앱 아이콘 512x512 준비 (10분)
- 현재: 1024x1024
- 변환: 512x512, 투명 배경 제거

#### 4. 구글 플레이 콘솔 계정 생성 (10분)
- URL: https://play.google.com/console
- 등록비: $25 (일회성)

#### 5. 앱 등록 및 AAB 업로드 (1-2시간)
- 앱 기본 정보 입력
- 스토어 등록정보 작성
- AAB 업로드
- 검토 제출

**총 예상 시간**: 3-4시간

---

## 참고사항

### AAB 다운로드 링크
https://expo.dev/artifacts/eas/vjWryc9VXv5Hd8KyodKTqe.aab

### 참고 문서
- `mobile/store_listing.md` - 앱 설명
- `mobile/play_store_guide.md` - 등록 가이드
- `구현_가이드_추가_기능_2025-10-18.md` - 다음 작업 상세 체크리스트

### 데이터베이스
- Supabase PostgreSQL (포트 6543)
- 확정 설정: DATABASE_CONFIRMED.md 참조

---

**작성일**: 2025-10-27
**작성자**: Claude Code
**세션 상태**: 완료
**다음 세션 예정일**: 2025-10-28
