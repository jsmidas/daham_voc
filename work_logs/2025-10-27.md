# Work Log - 2025-10-27

## 작업 개요
모바일 앱 출퇴근 권한 설정 기능 추가 및 사업장 선택 UI 개선 작업

## 완료된 작업

### 1. 출퇴근 기능 권한 시스템 구현 ✅
**목적**: 역할 기반이 아닌 개별 사용자별로 출퇴근 기능 표시 여부를 제어

#### 백엔드 (Prisma Schema)
- `User` 모델에 `canUseAttendance Boolean @default(false)` 필드 추가
- `npx prisma db push`로 데이터베이스 스키마 업데이트 완료

**파일**: `backend/prisma/schema.prisma:20`
```prisma
model User {
  // ...
  canUseAttendance    Boolean              @default(false)
  // ...
}
```

#### 백엔드 서비스 업데이트
**파일**: `backend/src/services/staff.service.ts`
- `createStaff()`: canUseAttendance 파라미터 추가 (line 175)
- `updateStaff()`: canUseAttendance 업데이트 지원 (line 271, 306)
- 모든 staff 조회 응답에 canUseAttendance 필드 포함 (lines 73, 129, 238, 337)

#### 웹 관리자 UI
**파일**: `web/src/pages/staff/StaffFormPage.tsx`
- "출퇴근 기능 사용" Switch 컨트롤 추가 (lines 371-380)
- 툴팁: "출퇴근 기능을 사용할 수 있는 권한을 부여합니다. 앱 메인 화면에 출퇴근 현황이 표시됩니다."
- 기본값: false (미사용)
- form initialValues 및 setFieldsValue에 canUseAttendance 포함 (lines 64, 243)

#### 모바일 앱 타입 및 로직
**파일**: `mobile/src/types/index.ts:16`
```typescript
export interface User {
  // ...
  canUseAttendance?: boolean;
}
```

**파일**: `mobile/src/screens/HomeScreen.tsx:19`
```typescript
// Before: const shouldShowAttendance = user?.role !== 'CLIENT';
// After:
const shouldShowAttendance = user?.canUseAttendance === true;
```

**변경사항**:
- 역할 기반 체크에서 권한 기반 체크로 변경
- `canUseAttendance === true`인 사용자만 출퇴근 섹션 및 메뉴 표시
- 쿼리 enabled 조건에도 동일하게 적용 (line 30)

#### Git Commit
- Mobile: `6f044e7` - feat: Add canUseAttendance permission for attendance feature visibility
- Main: `bdae5ed` - feat: Add attendance permission system for granular feature access control

---

### 2. 개발 환경 설정 및 테스트

#### 서버 실행
- 웹: `http://localhost:5176` (Vite)
- 모바일: `http://localhost:8082` (Expo with --clear flag)
- 백엔드: `http://localhost:3000` (Node.js)

#### 환경 변수 수정
**파일**: `mobile/.env`
```
# Before: API_BASE_URL=http://localhost:8000/api/v1
# After:
API_BASE_URL=http://localhost:3000/api/v1
```

#### 테스트 계정 비밀번호 재설정
- 전화번호: `01012345678` (관리자)
- 비밀번호: `1234`로 재설정
- bcrypt 해싱 적용

---

### 3. 사업장 선택 UI 3단계 계층 구조 구현 ✅

**요구사항**:
- 상위 권한자는 하위 사업장을 3단계 계층 구조로 볼 수 있어야 함
- **그룹 > 유형 > 사업장** 형태로 아코디언 표시
- 권한별 필터링 적용

**구현된 계층 구조**:
```
▼ 영남그룹A (15개)
  ▼ 도시락 (12개)
    └─ 영남사업장1
    └─ 영남사업장2
  ▶ 위탁 (3개)

▼ 본사그룹B (8개)
  ▶ 배송 (5개)
  ▼ 행사 (3개)
    └─ 본사행사장1

▼ 미지정 (5개)
  ▶ 도시락 (5개)
```

#### 모바일 앱 구현
**파일**: `mobile/src/components/SiteSelector.tsx`

1. **API 응답 구조 수정** (line 49)
   - 기존: `sitesData.data` (배열로 잘못 인식)
   - 수정: `sitesData.data.sites` (올바른 구조)

2. **사업장 유형 한글 변환 함수 추가** (lines 30-44)
   ```typescript
   const getSiteTypeName = (type: string) => {
     switch (type) {
       case 'CONSIGNMENT': return '위탁';
       case 'DELIVERY': return '배송';
       case 'LUNCHBOX': return '도시락';
       case 'EVENT': return '행사';
       default: return type;
     }
   };
   ```

3. **3단계 그룹화 로직** (lines 87-136)
   - 1단계: 그룹별 분류 (group.name or "미지정")
   - 2단계: 각 그룹 내에서 유형별 분류
   - 정렬: 그룹명 가나다순, 유형명 가나다순, "미지정" 맨 마지막

4. **아코디언 UI 구현** (lines 216-284)
   - 그룹 헤더: 접기/펼치기, 총 사업장 개수 표시
   - 유형 헤더: 들여쓰기, 접기/펼치기, 유형별 개수 표시
   - 사업장 항목: 선택 시 체크마크, 파란색 하이라이트

5. **스타일 추가** (lines 425-443)
   - `typeHeader`: 유형 헤더 스타일 (연한 회색 배경, 들여쓰기)
   - `typeName`: 유형명 스타일
   - `typeCount`: 유형별 개수 스타일

#### 백엔드 권한 필터링 구현
**파일**: `backend/src/controllers/site.controller.ts` (lines 32-40)

```typescript
// 권한별 필터링
if (user.role === 'HQ_ADMIN' && !filter.division) {
  filter.division = 'HQ';
} else if (user.role === 'YEONGNAM_ADMIN' && !filter.division) {
  filter.division = 'YEONGNAM';
}
```

**효과**:
- HQ_ADMIN: 본사(HQ) 사업장만 조회
- YEONGNAM_ADMIN: 영남지사(YEONGNAM) 사업장만 조회
- SUPER_ADMIN: 모든 사업장 조회

#### 웹 관리자 자동 Division 설정
**파일**: `web/src/pages/staff/StaffFormPage.tsx` (lines 119-136)

```typescript
const handleRoleChange = (role: string) => {
  setSelectedRole(role);

  // 권한에 따라 자동으로 division 설정
  let division = undefined;
  if (role === 'HQ_ADMIN' || role === 'SITE_MANAGER' || role === 'SITE_STAFF') {
    division = 'HQ';
  } else if (role === 'YEONGNAM_ADMIN') {
    division = 'YEONGNAM';
  }

  form.setFieldsValue({ role, division });
};
```

**효과**:
- 담당자 등록 시 권한 선택하면 자동으로 division 설정
- Division에 맞는 사업장만 배정 가능
- HQ_ADMIN 선택 → 본사 사업장만 표시
- YEONGNAM_ADMIN 선택 → 영남지사 사업장만 표시

**권한별 접근 제어**:
- `SUPER_ADMIN`: 모든 사업장
- `HQ_ADMIN`: 본사 사업장만
- `YEONGNAM_ADMIN`: 영남지사 사업장만
- `SITE_MANAGER/STAFF`: 배정된 사업장만
- `CLIENT`: 사업장 선택 UI 숨김

**다음 작업**:
- 내일 위탁사업장 등록 후 테스트
- 위탁 유형이 자동으로 "위탁"으로 분류되는지 확인

---

## 기술 스택

### Backend
- Prisma ORM + PostgreSQL (Supabase)
- Node.js + Express
- bcryptjs (비밀번호 해싱)

### Web Frontend
- React + TypeScript
- Vite
- Ant Design
- React Query

### Mobile
- React Native + Expo
- TypeScript
- React Query
- Zustand (상태 관리)

---

## 이슈 및 해결

### Issue 1: Metro Bundler 캐시 문제
**증상**: .env 파일 변경 후에도 이전 API_BASE_URL (8000 포트) 사용
**원인**: Metro Bundler가 환경 변수를 캐시
**해결**: `npx expo start --port 8082 --clear` 로 캐시 클리어 후 재시작

### Issue 2: 포트 충돌
**증상**: 여러 Expo 프로세스가 8082 포트 점유
**해결**: `taskkill //F //PID <PID>` 로 기존 프로세스 종료 후 재시작

---

## 다음 세션 계획

1. **사업장 선택 UI 계층 구조 완성**
   - 그룹화 로직 구현
   - 아코디언 UI 구현
   - 권한별 필터링

2. **테스트 및 검증**
   - 각 권한별 사업장 표시 확인
   - 출퇴근 권한 토글 테스트
   - 모바일 앱에서 권한 변경 반영 확인

3. **배포 준비**
   - 변경사항 커밋 및 푸시
   - 프로덕션 배포 (선택사항)

---

## 참고사항

### 데이터베이스 사용자 현황
모든 사용자의 `canUseAttendance` 기본값: `false`
- 출퇴근 기능 테스트를 위해서는 웹 관리자 페이지에서 설정 필요

### 사업장 그룹 구조 (Prisma Schema)
```prisma
model SiteGroup {
  id          String      @id @default(uuid())
  name        String
  division    Division
  description String?
  markerShape MarkerShape @default(CIRCLE)
  markerColor String      @default("#1890ff")
  sortOrder   Int         @default(0)
  isActive    Boolean     @default(true)
  sites       Site[]
  // ...
}

model Site {
  id        String     @id @default(uuid())
  name      String
  type      SiteType
  division  Division
  groupId   String?
  group     SiteGroup? @relation(fields: [groupId], references: [id])
  // ...
}
```

---

**작성일**: 2025-10-27
**작성자**: Claude Code
**세션 상태**: 진행 중
