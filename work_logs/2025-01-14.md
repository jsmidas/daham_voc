# Work Log - 2025-01-14

## 작업 개요
담당자 관리 계층 구조 개선, GitHub Actions 자동 배포 구축, 배포 문서화

## 완료된 작업

### 1. 담당자 사업장 배정 계층 구조 개선 ✅

**목적**: 사업장을 하나하나 찾는 불편함 해소, 그룹 단위 자동 관리

#### 문제점
- 기존: Transfer 컴포넌트로 90개 사업장을 일일이 찾아야 함
- 본사/영남지사 관리자가 개별 사업장을 수동으로 배정
- 새로운 사업장이 추가되면 다시 배정 필요

#### 해결 방안

##### Database Schema 변경
**파일**: `backend/prisma/schema.prisma`

**추가된 모델**:
```prisma
model StaffSiteGroup {
  id          String    @id @default(uuid())
  staffId     String
  siteGroupId String
  assignedAt  DateTime  @default(now())
  removedAt   DateTime?

  siteGroup   SiteGroup @relation(fields: [siteGroupId], references: [id], onDelete: Cascade)
  staff       Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, siteGroupId])
  @@index([staffId])
  @@index([siteGroupId])
}
```

**주요 변경**:
1. `Site.groupId` 필수 항목으로 변경 (`String?` → `String`)
2. 그룹 배정 (`StaffSiteGroup`) + 개별 배정 (`StaffSite`) 하이브리드 시스템

---

##### Backend Service 업데이트
**파일**: `backend/src/services/staff.service.ts`

**주요 기능**:
1. `createStaff` / `updateStaff`: `siteGroupIds` 파라미터 추가
2. `assignStaffToSitesAndGroups`: 그룹 배정 로직 구현
3. 그룹 배정 시 해당 그룹의 모든 사업장 자동 접근

**파일**: `backend/src/services/site-group.service.ts`

**변경사항**:
- `removeSitesFromGroup`: 사업장은 항상 그룹에 속해야 하므로 제거 불가
- 그룹 없는 사업장 조회 로직 제거 (groupId 필수)

---

##### Permission Utility 생성
**파일**: `backend/src/utils/permission.util.ts` (NEW)

**주요 함수**:

1. **canAccessSite(userId, siteId)**: 사용자가 특정 사업장에 접근 가능한지 확인
   - SUPER_ADMIN: 모든 사업장 접근
   - 개별 사업장 배정 확인
   - 그룹 배정 확인

2. **getAccessibleSiteIds(userId)**: 접근 가능한 모든 사업장 ID 배열
   - 개별 배정 사업장
   - 그룹 배정의 모든 사업장
   - Set으로 중복 제거

3. **getDivisionFilter(userId)**: Division 기반 필터 조건
   - HQ_ADMIN → HQ만
   - YEONGNAM_ADMIN → YEONGNAM만

---

##### Frontend UI 변경
**파일**: `web/src/pages/staff/StaffFormPage.tsx`

**주요 변경 (Transfer → Tree)**:

1. **Tree 데이터 구조** (lines 200-280)
   ```typescript
   const treeData = useMemo(() => {
     // Division > Group > Sites 3단계 계층
     const divisions = ['HQ', 'YEONGNAM'];
     return divisions.map(division => ({
       title: division === 'HQ' ? '본사' : '영남지사',
       key: `division-${division}`,
       children: groupsForDivision.map(group => ({
         title: `${group.name} (${sitesInGroup.length}개)`,
         key: `group-${group.id}`,
         children: sitesInGroup.map(site => ({
           title: site.name,
           key: `site-${site.id}`,
         })),
       })),
     }));
   }, [siteGroupsData, sitesData]);
   ```

2. **Checked Keys 파싱** (lines 132-146)
   - `group-{uuid}` → `siteGroupIds`
   - `site-{uuid}` → `siteIds`
   - division 키는 무시

3. **초기값 설정** (lines 148-171)
   - 기존 그룹 배정 → `group-{id}`
   - 기존 개별 배정 → `site-{id}`
   - 부모 노드 자동 체크 (checkStrictly: false)

**TypeScript 에러 수정**:
- `canUseAttendance: (staffData.user as any).canUseAttendance || false`

---

##### 사업장 생성 시 그룹 필수 선택
**파일**: `web/src/pages/site/SiteFormPage.tsx`

**변경사항**:
```typescript
<Form.Item
  label="사업장 그룹"
  name="groupId"
  rules={[{ required: true, message: '사업장 그룹을 선택하세요' }]}
  tooltip="사업장이 속한 그룹을 선택하세요 (필수)"
>
  <Select placeholder="그룹 선택" loading={isLoadingGroups} />
  {/* allowClear 제거 */}
</Form.Item>
```

---

#### 최종 구조
```
담당자 배정 방식:
1. 그룹 배정 (StaffSiteGroup)
   - 본사 그룹 체크 → 해당 그룹의 모든 사업장 자동 접근
   - 새 사업장 추가 시 자동으로 접근 가능

2. 개별 사업장 배정 (StaffSite)
   - 특정 사업장만 담당하는 경우
   - 그룹과 무관하게 개별 배정

3. 하이브리드
   - 그룹 + 개별 사업장 동시 배정 가능
   - 중복 제거 (Set 사용)
```

**Git Commits**:
- Backend/Web 다수 커밋 (TypeScript 에러 수정 포함)
- Main: 배포 완료

---

### 2. 프로덕션 배포 (GCP VM) ✅

#### 배포 과정 (2-3시간 소요)

##### 발생한 주요 에러들

**1. TypeScript 컴파일 에러**:
- `backend/src/utils/permission.util.ts`: 미사용 import 제거 (`Role`)
- `web/src/pages/staff/StaffFormPage.tsx`: type assertion 추가
- `web/src/pages/meal-count/MealCountListPage.tsx`: 미사용 변수 제거

**2. Git 충돌**:
```bash
# 해결
git reset --hard origin/main
git pull origin main
```

**3. PM2 설정 오류 (ecosystem.config.js)**:

**문제점**:
```javascript
// ❌ 잘못된 설정
{
  name: 'daham-voc-api',
  cwd: '/root/daham_voc',  // 하드코딩된 경로
}
```

**해결**:
```javascript
// ✅ 올바른 설정
const path = require('path');

{
  name: 'daham-voc-api',
  script: './backend/dist/server.js',
  cwd: path.resolve(__dirname),
  env_file: './backend/.env',
  exec_mode: 'cluster',
}
```

**4. Frontend serve 명령어 오류**:

**문제점**:
```javascript
// ❌ 잘못된 설정
{
  name: 'daham-web',
  script: 'serve',
  args: '-s dist -p 5173',
  exec_mode: 'cluster',  // serve는 cluster 모드 지원 안 함
}
```

**해결**:
```javascript
// ✅ 올바른 설정
{
  name: 'daham-web',
  script: 'npx',
  args: 'serve -s dist -p 5173',
  cwd: path.resolve(__dirname, 'web'),
  exec_mode: 'fork',  // fork 모드로 변경
}
```

**5. 환경변수 로딩 문제**:
- `.env` 파일을 프로젝트 루트에 복사: `cp ~/daham_voc/backend/.env ~/daham_voc/.env`
- `ecosystem.config.js`에 `env_file: './backend/.env'` 추가

---

#### 배포 결과

**PM2 상태**:
```
┌─────┬───────────────────┬─────────┬─────────┬─────────┐
│ id  │ name              │ status  │ memory  │ cpu     │
├─────┼───────────────────┼─────────┼─────────┼─────────┤
│ 12  │ daham-voc-api     │ online  │ 114.4mb │ 0%      │
│ 17  │ daham-web         │ online  │ 62.4mb  │ 0%      │
└─────┴───────────────────┴─────────┴─────────┴─────────┘
```

**서비스 URL**:
- Backend: https://api.dahamvoc.co.kr
- Frontend: https://admin.dahamvoc.co.kr

**확인 결과**: Tree 컴포넌트 정상 작동 ✅

---

### 3. GitHub Actions 자동 배포 구축 ✅

#### 기존 워크플로우 문제점

**파일**: `.github/workflows/deploy.yml`

**문제**:
1. Frontend를 `/var/www`에 직접 복사 → 실제로는 PM2로 실행
2. `ecosystem.config.js` 제대로 활용 안 함
3. 단계별로 분리되어 있어 비효율적

---

#### 수정된 워크플로우

**주요 변경사항**:

**AS-IS**:
```yaml
- name: Deploy Backend
  # backend만 빌드 & 재시작

- name: Deploy Frontend
  # /var/www에 복사
```

**TO-BE**:
```yaml
- name: Deploy to GCP VM
  run: |
    ssh user@host << 'ENDSSH'
      # 1. 코드 업데이트
      git pull origin main
      git submodule update --init --recursive

      # 2. Backend 빌드
      cd backend
      npm install
      npx prisma generate
      npm run build

      # 3. Frontend 빌드
      cd ../web
      npm install
      npm run build

      # 4. PM2 재시작 (ecosystem 사용)
      cd ..
      pm2 restart ecosystem.config.js
      pm2 save
    ENDSSH
```

**특징**:
- 한 번의 SSH 연결로 전체 배포
- 실제 작동하는 방식 그대로 반영
- `ecosystem.config.js` 활용

---

#### GitHub Secrets 설정 가이드

**파일**: `GITHUB_ACTIONS_SETUP.md` (NEW)

**필요한 Secrets**:
1. `GCP_SSH_PRIVATE_KEY`: SSH 개인키
2. `GCP_VM_IP`: GCP VM IP (예: `dahamvoc.co.kr`)
3. `GCP_VM_USER`: SSH 사용자명 (예: `sos1253`)

**자동/수동 배포 방법**:
- 자동: `git push origin main`
- 수동: GitHub Actions 탭 → "Run workflow"

---

### 4. 배포 문서 정리 ✅

#### DEPLOYMENT.md 작성
**파일**: `DEPLOYMENT.md` (NEW)

**목차**:
1. 자동 배포 (GitHub Actions)
2. 수동 배포 (GCP VM SSH)
3. 배포 확인 (PM2 status, health check)
4. 트러블슈팅 (10가지 에러 사례)

**주요 섹션**:
- PM2 명령어 모음
- 로그 확인 방법
- 롤백 방법
- 중요 파일 위치

---

#### 수동 배포 스크립트 정리

**작업**:
1. `deprecated/` 폴더 생성
2. 기존 스크립트 이동:
   - `deploy-all.sh`
   - `deploy-backend.sh`
   - `deploy-web.sh`

3. `deprecated/README.md` 작성:
   - Deprecated 이유 설명
   - 대체 방법 안내 (GitHub Actions)
   - 참고 문서 링크

**목적**:
- 혼란 방지 (미래 작업자/AI)
- 응급 상황 시 참고용 보관

---

## 교훈

### 개발 vs 배포 시간
- **개발 시간**: 30분~1시간 (계층 구조, DB 스키마)
- **배포 시간**: 2~3시간 (PM2 설정, 에러 10번 이상 수정)

**개선 결과**:
- GitHub Actions 자동 배포로 다음부터는 `git push`만으로 배포 완료
- 수동 배포 시행착오 없앰

### PM2 ecosystem.config.js 중요 포인트
1. `cwd`: 절대 경로 대신 `path.resolve(__dirname)` 사용
2. `serve` 명령어: `exec_mode: 'fork'` 필수
3. `script`: `npx`로 실행하면 argument parsing 문제 해소
4. 환경변수: `env_file` + 루트 `.env` 복사 필요

### StaffSiteGroup 하이브리드 접근법
- 그룹 배정: 관리자급 (자동 확장)
- 개별 배정: 담당자급 (특정 사업장만)
- 두 가지 동시 사용 가능 → 유연성 확보

---

## 기술 스택

### Backend
- Prisma ORM + PostgreSQL (Supabase)
- Node.js + Express
- PM2 (Process Manager)

### Web Frontend
- React + TypeScript + Vite
- Ant Design (Tree 컴포넌트)
- React Query

### Infrastructure
- GCP VM (Compute Engine)
- GitHub Actions (CI/CD)
- Nginx (Reverse Proxy)

---

## 참고사항

### 주요 파일
- `backend/src/utils/permission.util.ts`: 권한 체크 유틸
- `ecosystem.config.js`: PM2 설정 (cluster/fork)
- `.github/workflows/deploy.yml`: 자동 배포 워크플로우

### 배포 문서
- `DEPLOYMENT.md`: 전체 배포 가이드
- `GITHUB_ACTIONS_SETUP.md`: GitHub Secrets 설정
- `deprecated/README.md`: 구 배포 스크립트 설명

### 데이터베이스
- Supabase PostgreSQL (포트 6543)
- 확정 설정: CLAUDE.md, DATABASE_CONFIRMED.md 참조

### 프로덕션 URL
- Backend API: https://api.dahamvoc.co.kr
- Web Admin: https://admin.dahamvoc.co.kr

---

## 다음 세션 계획

### 권한 시스템 고도화
1. 출퇴근 권한 세분화 (`canUseAttendance` 활용)
2. 식수 관리 권한 추가 가능성
3. VOC 읽기/쓰기 권한 분리

### 모바일 앱 업데이트
1. 계층 구조 사업장 선택 동기화
2. 그룹 배정 담당자 확인 로직

### 배포 자동화 검증
1. GitHub Actions 첫 실행 테스트
2. Secrets 설정 완료 확인
3. 자동 배포 로그 모니터링

---

**작성일**: 2025-01-14
**작성자**: Claude Code
**세션 상태**: 완료
**주요 성과**: 계층 구조 사업장 배정 + 자동 배포 시스템 구축
