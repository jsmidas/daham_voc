# Daham VOC 프로그램 개발 가이드

## 목차
1. [현재 계획의 문제점 분석](#1-현재-계획의-문제점-분석)
2. [보완책 및 개선사항](#2-보완책-및-개선사항)
3. [상세 기술 스택](#3-상세-기술-스택)
4. [데이터베이스 스키마 상세 설계](#4-데이터베이스-스키마-상세-설계)
5. [API 설계 가이드](#5-api-설계-가이드)
6. [보안 구현 가이드](#6-보안-구현-가이드)
7. [개발 환경 설정](#7-개발-환경-설정)
8. [단계별 구현 가이드](#8-단계별-구현-가이드)

---

## 1. 현재 계획의 문제점 분석

### 1.1 데이터베이스 설계 문제
- ❌ **Users/Roles 테이블 누락**: 인증 시스템에 필요한 사용자 테이블이 명시되지 않음
- ❌ **관계 정의 불명확**: 외래키, CASCADE 옵션 등이 명시되지 않음
- ❌ **데이터 타입 미지정**: VARCHAR 길이, DECIMAL 정밀도 등 구체적 타입 없음
- ❌ **인덱스 전략 부재**: 성능 최적화를 위한 인덱스 계획 없음
- ❌ **감사(Audit) 로그 부재**: created_at, updated_at, deleted_at 필드 누락

### 1.2 기술 스택 구체성 부족
- ❌ **ORM/ODM 미정**: PostgreSQL, MongoDB 접근 방법 불명확
- ❌ **이미지 처리 라이브러리 미정**: Sharp, Jimp 등 선택 필요
- ❌ **인증 라이브러리 미정**: Passport, jsonwebtoken 등
- ❌ **테스트 프레임워크 미정**: Jest, Mocha 등
- ❌ **API 문서화 도구 미정**: Swagger, Postman 등

### 1.3 개발 순서 문제
- ❌ **프론트엔드 조기 착수**: API 완성 전 프론트엔드 개발 시작
- ❌ **테스트 전략 부재**: 단위/통합 테스트 시점 불명확
- ❌ **데이터 마이그레이션 미고려**: 스키마 변경 관리 방법 없음

### 1.4 배포 및 인프라 문제
- ❌ **환경 구분 없음**: 개발/스테이징/프로덕션 환경 분리 안됨
- ❌ **DB 백업 전략 없음**: 데이터 손실 복구 방법 부재
- ❌ **모니터링 도구 미정**: 에러 추적, 성능 모니터링 미고려
- ❌ **CI/CD 파이프라인 구체화 부족**: 자동 배포 프로세스 불명확

### 1.5 보안 고려사항 부족
- ❌ **파일 업로드 검증 미흡**: 파일 크기, 타입, 바이러스 검사 전략 없음
- ❌ **Rate Limiting 부재**: API 남용 방지 장치 없음
- ❌ **CORS 정책 미정**: 허용 도메인 설정 필요
- ❌ **API 버저닝 없음**: API 변경 시 하위 호환성 유지 방법 없음
- ❌ **민감 정보 암호화 미흡**: 연락처, 주소 등 개인정보 암호화 미고려

### 1.6 성능 최적화 부족
- ❌ **이미지 CDN 전략 불명확**: GCP Storage만으로는 불충분
- ❌ **캐싱 전략 없음**: Redis 등 캐시 레이어 미고려
- ❌ **대용량 데이터 처리 미흡**: 페이지네이션, 무한 스크롤 전략 없음
- ❌ **쿼리 최적화 미고려**: N+1 문제, JOIN 최적화 방법 없음

### 1.7 모바일 앱 구현 부족
- ❌ **오프라인 모드 구체화 필요**: Local DB (SQLite, Realm) 전략 미정
- ❌ **푸시 알림 미고려**: FCM 연동 방법 없음
- ❌ **앱 배포 전략 없음**: App Store, Play Store 배포 프로세스 부재
- ❌ **앱 업데이트 전략 없음**: 강제 업데이트, 선택 업데이트 방법 미정

---

## 2. 보완책 및 개선사항

### 2.1 데이터베이스 설계 개선
✅ **Users 테이블 추가**
✅ **Roles 테이블 추가** (관리자, 담당자, 고객사 구분)
✅ **모든 테이블에 공통 필드 추가** (id, created_at, updated_at, deleted_at)
✅ **외래키 제약조건 명시** (CASCADE, SET NULL 등)
✅ **인덱스 전략 수립** (검색용, 정렬용 인덱스)
✅ **소프트 삭제 구현** (deleted_at으로 논리 삭제)

### 2.2 기술 스택 구체화
✅ **백엔드**
  - ORM: **Prisma** (타입 안전성, 마이그레이션 우수)
  - ODM: **Mongoose** (MongoDB 표준)
  - 인증: **Passport.js + JWT**
  - 이미지 처리: **Sharp** (고성능)
  - 검증: **Joi** 또는 **Zod**

✅ **프론트엔드**
  - 상태 관리: **Zustand** (웹), **Context API + AsyncStorage** (모바일)
  - API 통신: **Axios + React Query**
  - 폼 관리: **React Hook Form**

✅ **인프라 & DevOps**
  - 캐싱: **Redis** (세션, 빈번한 조회 데이터)
  - 로그: **Winston + GCP Cloud Logging**
  - 모니터링: **Sentry** (에러 추적)
  - API 문서: **Swagger/OpenAPI**

### 2.3 개발 순서 개선
✅ **Phase 재조정**
  1. **Phase 1**: DB 스키마 + 백엔드 API 골격 (3주)
  2. **Phase 2**: 핵심 API 완성 + 테스트 (2주)
  3. **Phase 3**: 웹 관리자 페이지 (2주)
  4. **Phase 4**: 모바일 앱 (3주)
  5. **Phase 5**: 통합 테스트 + 배포 (1주)

### 2.4 보안 강화 방안
✅ **파일 업로드 보안**
  - 파일 크기 제한: 10MB
  - 허용 타입: image/jpeg, image/png, image/webp
  - 바이러스 스캔: ClamAV 또는 GCP 보안 스캔
  - 파일명 난수화: UUID 사용

✅ **API 보안**
  - Rate Limiting: express-rate-limit (분당 100 요청)
  - CORS: 허용 도메인 화이트리스트
  - Helmet.js: HTTP 헤더 보안
  - API 버저닝: /api/v1/ 형식

### 2.5 성능 최적화 전략
✅ **이미지 최적화**
  - 업로드 시 WebP 자동 변환
  - 썸네일 자동 생성 (300px, 600px)
  - CDN: Cloudflare 또는 GCP CDN 앞단 배치

✅ **데이터베이스 최적화**
  - 읽기 전용 복제본 구성 (조회 성능 향상)
  - 인덱스: site_id, date, user_id 등
  - 파티셔닝: 날짜별 테이블 분할 고려 (대용량 시)

✅ **캐싱 전략**
  - Redis 캐시: 식단 데이터 (TTL 1일)
  - 브라우저 캐시: 이미지 (max-age 7일)
  - API 응답 캐시: 자주 조회되는 통계 데이터

---

## 3. 상세 기술 스택

### 3.1 백엔드
```
- Runtime: Node.js 20.x LTS
- Framework: Express.js 4.x
- Language: TypeScript 5.x
- ORM: Prisma 5.x
- ODM: Mongoose 8.x
- Authentication: Passport.js + jsonwebtoken
- Validation: Zod
- Image Processing: Sharp
- Testing: Jest + Supertest
- Logger: Winston
- Security: Helmet, express-rate-limit, cors
```

### 3.2 데이터베이스
```
- PostgreSQL 15.x (메인 DB)
  - Connection Pool: pg (Prisma 내장)
  - Migration: Prisma Migrate

- MongoDB 7.x (이미지 메타데이터)
  - Driver: Mongoose

- Redis 7.x (캐싱, 세션)
  - Client: ioredis
```

### 3.3 프론트엔드 (Web)
```
- Framework: React 18.x
- Build Tool: Vite 5.x
- Language: TypeScript
- UI Library: Ant Design 5.x
- State Management: Zustand
- API Client: Axios + React Query
- Form: React Hook Form + Zod
- Map: Kakao Maps SDK
- Charts: Recharts
```

### 3.4 프론트엔드 (Mobile)
```
- Framework: React Native 0.73.x
- UI Library: React Native Paper 5.x
- Navigation: React Navigation 6.x
- State Management: Context API + AsyncStorage
- API Client: Axios
- Map: react-native-kakao-maps
- GPS: react-native-geolocation-service
- Camera: react-native-vision-camera
- Image Picker: react-native-image-picker
- Local DB: WatermelonDB (오프라인)
- Push: React Native Firebase (FCM)
```

### 3.5 인프라 & DevOps
```
- Cloud Platform: GCP
  - Compute: Cloud Run
  - Storage: Cloud Storage
  - Database: Cloud SQL (PostgreSQL), Atlas (MongoDB)
  - Cache: Memorystore (Redis)

- CI/CD: GitHub Actions
- Container: Docker + docker-compose
- Monitoring: Sentry (에러), GCP Cloud Monitoring
- Logging: Winston + GCP Cloud Logging
- API Docs: Swagger/OpenAPI 3.0
```

---

## 4. 데이터베이스 스키마 상세 설계

### 4.1 PostgreSQL 스키마 (Prisma)

```prisma
// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 공통 필드 모델
model User {
  id            String      @id @default(uuid())
  email         String      @unique
  password      String      // bcrypt 해시
  name          String
  phone         String?
  role          Role        @default(STAFF)
  isActive      Boolean     @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  deletedAt     DateTime?   // 소프트 삭제

  // 관계
  staff         Staff?
  feedbacks     CustomerFeedback[]
  mealPhotos    MealPhoto[]
  attendances   Attendance[]

  @@index([email])
  @@index([role])
}

enum Role {
  ADMIN           // 관리자
  MANAGER         // 지사장
  part manager    // 파트관리자
  STAFF           // 담당자
  CLIENT          // 고객사
}

model Site {
  id                String      @id @default(uuid())
  name              String
  type              SiteType
  address           String
  latitude          Float
  longitude         Float
  contactPerson1    String?     // 고객사 담당자1
  contactPhone1     String?
  contactPerson2    String?     // 고객사 담당자2
  contactPhone2     String?
  isActive          Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  deletedAt         DateTime?

  // 관계
  staffSites        StaffSite[]
  menus             Menu[]
  mealPhotos        MealPhoto[]
  feedbacks         CustomerFeedback[]
  attendances       Attendance[]
  attendanceSettings AttendanceSetting[]

  @@index([type])
  @@index([isActive])
}

enum SiteType {
  CONSIGNMENT     // 위탁
  DELIVERY        // 운반급식
  LUNCHBOX        // 도시락
  EVENT           // 행사
}

model Staff {
  id            String      @id @default(uuid())
  userId        String      @unique
  employeeNo    String      @unique
  department    String?     // 본사, 영남지사 등
  position      String?     // 직책
  managerId     String?     // 상위 관리자
  averageRating Float       @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  deletedAt     DateTime?

  // 관계
  user          User        @relation(fields: [userId], references: [id])
  manager       Staff?      @relation("StaffHierarchy", fields: [managerId], references: [id])
  subordinates  Staff[]     @relation("StaffHierarchy")
  staffSites    StaffSite[]

  @@index([managerId])
  @@index([department])
}

// 담당자-사업장 중간 테이블 (다대다 관계)
model StaffSite {
  id          String      @id @default(uuid())
  staffId     String
  siteId      String
  isPrimary   Boolean     @default(false)  // 주 담당 여부
  assignedAt  DateTime    @default(now())
  removedAt   DateTime?

  // 관계
  staff       Staff       @relation(fields: [staffId], references: [id])
  site        Site        @relation(fields: [siteId], references: [id])

  @@unique([staffId, siteId])
  @@index([staffId])
  @@index([siteId])
}

model Menu {
  id            String      @id @default(uuid())
  siteId        String
  date          DateTime    @db.Date
  mealType      MealType
  menuItems     String      // JSON 또는 텍스트
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  deletedAt     DateTime?

  // 관계
  site          Site        @relation(fields: [siteId], references: [id])

  @@unique([siteId, date, mealType])
  @@index([siteId, date])
  @@index([date])
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

model MealPhoto {
  id            String      @id @default(uuid())
  siteId        String
  uploaderId    String
  imageUrl      String
  thumbnailUrl  String?
  mealType      MealType?
  photoType     PhotoType   @default(SERVING)
  takenAt       DateTime
  latitude      Float?
  longitude     Float?
  feedback      String?     // 관리자 피드백
  mongoMetaId   String?     // MongoDB 메타데이터 ID
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  deletedAt     DateTime?

  // 관계
  site          Site        @relation(fields: [siteId], references: [id])
  uploader      User        @relation(fields: [uploaderId], references: [id])

  @@index([siteId, takenAt])
  @@index([uploaderId])
  @@index([takenAt])
}

enum PhotoType {
  SERVING       // 배식 준비
  LEFTOVER      // 잔반
  FACILITY      // 시설
}

model CustomerFeedback {
  id            String        @id @default(uuid())
  siteId        String
  authorId      String
  authorType    FeedbackAuthorType
  content       String        @db.Text
  rating        Int?          @default(0)  // 1-5점
  status        FeedbackStatus @default(PENDING)
  adminReply    String?       @db.Text
  repliedAt     DateTime?
  repliedBy     String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  deletedAt     DateTime?

  // 관계
  site          Site          @relation(fields: [siteId], references: [id])
  author        User          @relation(fields: [authorId], references: [id])

  @@index([siteId, status])
  @@index([authorId])
  @@index([status])
  @@index([createdAt])
}

enum FeedbackAuthorType {
  STAFF         // 담당자
  CLIENT        // 고객사
}

enum FeedbackStatus {
  PENDING       // 미처리
  IN_PROGRESS   // 처리중
  RESOLVED      // 처리완료
  CLOSED        // 종료
}

model Attendance {
  id            String      @id @default(uuid())
  staffId       String
  siteId        String
  checkInTime   DateTime
  checkInLat    Float?
  checkInLng    Float?
  checkOutTime  DateTime?
  checkOutLat   Float?
  checkOutLng   Float?
  status        AttendanceStatus @default(NORMAL)
  note          String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  deletedAt     DateTime?

  // 관계
  staff         User        @relation(fields: [staffId], references: [id])
  site          Site        @relation(fields: [siteId], references: [id])

  @@index([staffId, checkInTime])
  @@index([siteId, checkInTime])
  @@index([checkInTime])
}

enum AttendanceStatus {
  NORMAL        // 정상
  LATE          // 지각
  EARLY_LEAVE   // 조퇴
  OUTSIDE_RANGE // 사업장 외부 체크인
}

model AttendanceSetting {
  id              String      @id @default(uuid())
  siteId          String
  expectedCheckIn String      // HH:mm 형식 (예: "09:00")
  expectedCheckOut String     // HH:mm 형식
  allowedRadius   Int         @default(100)  // 미터 단위
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // 관계
  site            Site        @relation(fields: [siteId], references: [id])

  @@index([siteId])
}

// 카카오맵 배송 정보
model DeliveryRoute {
  id              String      @id @default(uuid())
  name            String      // 명칭
  siteId          String?     // 연결된 사업장 (선택)

  route1          String?
  vehicle1        String?
  driver1         String?

  route2          String?
  vehicle2        String?
  driver2         String?

  route3          String?
  vehicle3        String?
  driver3         String?

  latitude        Float?
  longitude       Float?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?

  @@index([siteId])
}
```

### 4.2 MongoDB 스키마 (Mongoose)

```javascript
// imageMetadata.model.js
const mongoose = require('mongoose');

const imageMetadataSchema = new mongoose.Schema({
  postgresId: {
    type: String,
    required: true,
    index: true
  },
  originalName: String,
  mimeType: String,
  size: Number,  // bytes
  width: Number,
  height: Number,
  exif: {
    make: String,
    model: String,
    dateTime: Date,
    gps: {
      latitude: Number,
      longitude: Number,
      altitude: Number
    }
  },
  processing: {
    compressed: Boolean,
    thumbnailGenerated: Boolean,
    webpConverted: Boolean,
    compressionRatio: Number
  },
  storage: {
    gcpBucket: String,
    gcpPath: String,
    thumbnailPath: String,
    cdnUrl: String
  },
  scanned: {
    virusScanStatus: {
      type: String,
      enum: ['pending', 'clean', 'infected', 'error'],
      default: 'pending'
    },
    scannedAt: Date
  }
}, {
  timestamps: true
});

imageMetadataSchema.index({ postgresId: 1 });
imageMetadataSchema.index({ createdAt: -1 });

module.exports = mongoose.model('ImageMetadata', imageMetadataSchema);
```

---

## 5. API 설계 가이드

### 5.1 API 버전 관리
- Base URL: `https://api.dahamvoc.com/api/v1`
- 버전별 네임스페이스: `/api/v1`, `/api/v2`

### 5.2 인증 방식
- **Header**: `Authorization: Bearer <JWT_TOKEN>`
- **Token Payload**:
```json
{
  "userId": "uuid",
  "email": "user@example.com",
  "role": "STAFF",
  "iat": 1234567890,
  "exp": 1234567890
}
```

### 5.3 API 엔드포인트 구조

#### 인증 (Authentication)
```
POST   /api/v1/auth/register       # 회원가입
POST   /api/v1/auth/login          # 로그인
POST   /api/v1/auth/logout         # 로그아웃
POST   /api/v1/auth/refresh        # 토큰 갱신
GET    /api/v1/auth/me             # 현재 사용자 정보
PUT    /api/v1/auth/password       # 비밀번호 변경
```

#### 사업장 (Sites)
```
GET    /api/v1/sites               # 사업장 목록 (필터링, 페이지네이션)
GET    /api/v1/sites/:id           # 사업장 상세
POST   /api/v1/sites               # 사업장 생성 (ADMIN)
PUT    /api/v1/sites/:id           # 사업장 수정 (ADMIN)
DELETE /api/v1/sites/:id           # 사업장 삭제 (ADMIN)
GET    /api/v1/sites/:id/staff     # 사업장 담당자 목록
POST   /api/v1/sites/:id/staff     # 담당자 배정 (ADMIN)
```

#### 식단 (Menus)
```
GET    /api/v1/menus               # 식단 목록 (사업장별, 날짜별)
GET    /api/v1/menus/:id           # 식단 상세
POST   /api/v1/menus               # 식단 생성
POST   /api/v1/menus/bulk          # 식단 일괄 생성
PUT    /api/v1/menus/:id           # 식단 수정
DELETE /api/v1/menus/:id           # 식단 삭제
```

#### 배식 사진 (Meal Photos)
```
GET    /api/v1/photos              # 사진 목록 (필터링)
GET    /api/v1/photos/:id          # 사진 상세
POST   /api/v1/photos/upload       # 사진 업로드
PUT    /api/v1/photos/:id/feedback # 관리자 피드백 추가
DELETE /api/v1/photos/:id          # 사진 삭제
```

#### VOC (Feedbacks)
```
GET    /api/v1/feedbacks           # VOC 목록
GET    /api/v1/feedbacks/:id       # VOC 상세
POST   /api/v1/feedbacks           # VOC 작성
PUT    /api/v1/feedbacks/:id/reply # 관리자 답변
PUT    /api/v1/feedbacks/:id/status # 상태 변경
DELETE /api/v1/feedbacks/:id      # VOC 삭제
```

#### 담당자 (Staff)
```
GET    /api/v1/staff               # 담당자 목록
GET    /api/v1/staff/:id           # 담당자 상세
GET    /api/v1/staff/:id/ratings   # 담당자 평점 내역
GET    /api/v1/staff/:id/sites     # 담당 사업장 목록
PUT    /api/v1/staff/:id           # 담당자 정보 수정
```

#### 근태 (Attendance)
```
GET    /api/v1/attendance          # 근태 목록 (필터링)
GET    /api/v1/attendance/:id      # 근태 상세
POST   /api/v1/attendance/checkin  # 출근 체크인
PUT    /api/v1/attendance/:id/checkout # 퇴근 체크아웃
GET    /api/v1/attendance/settings/:siteId # 사업장 근태 설정 조회
PUT    /api/v1/attendance/settings/:siteId # 사업장 근태 설정 수정
```

#### 통계 & 대시보드 (Statistics)
```
GET    /api/v1/stats/dashboard     # 대시보드 요약 통계
GET    /api/v1/stats/voc           # VOC 통계
GET    /api/v1/stats/ratings       # 평점 통계
GET    /api/v1/stats/attendance    # 근태 통계
```

### 5.4 응답 형식

#### 성공 응답
```json
{
  "success": true,
  "data": {
    // 실제 데이터
  },
  "meta": {
    "page": 1,
    "limit": 20,
    "total": 100
  }
}
```

#### 에러 응답
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "입력값이 올바르지 않습니다",
    "details": [
      {
        "field": "email",
        "message": "이메일 형식이 올바르지 않습니다"
      }
    ]
  }
}
```

### 5.5 에러 코드 정의
```
400 BAD_REQUEST           - 잘못된 요청
401 UNAUTHORIZED          - 인증 실패
403 FORBIDDEN             - 권한 없음
404 NOT_FOUND             - 리소스 없음
409 CONFLICT              - 중복된 리소스
413 PAYLOAD_TOO_LARGE     - 파일 크기 초과
422 VALIDATION_ERROR      - 검증 실패
429 TOO_MANY_REQUESTS     - 요청 횟수 초과
500 INTERNAL_SERVER_ERROR - 서버 오류
```

---

## 6. 보안 구현 가이드

### 6.1 인증 & 인가

```typescript
// middleware/auth.middleware.ts
import jwt from 'jsonwebtoken';
import { Request, Response, NextFunction } from 'express';

export const authenticate = async (req: Request, res: Response, next: NextFunction) => {
  const token = req.headers.authorization?.replace('Bearer ', '');

  if (!token) {
    return res.status(401).json({ success: false, error: 'No token provided' });
  }

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET!);
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(401).json({ success: false, error: 'Invalid token' });
  }
};

export const authorize = (...roles: string[]) => {
  return (req: Request, res: Response, next: NextFunction) => {
    if (!req.user || !roles.includes(req.user.role)) {
      return res.status(403).json({ success: false, error: 'Insufficient permissions' });
    }
    next();
  };
};
```

### 6.2 Rate Limiting

```typescript
// middleware/rateLimit.middleware.ts
import rateLimit from 'express-rate-limit';

export const apiLimiter = rateLimit({
  windowMs: 1 * 60 * 1000, // 1분
  max: 100, // 최대 100 요청
  message: 'Too many requests from this IP'
});

export const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15분
  max: 5, // 최대 5회 로그인 시도
  message: 'Too many login attempts'
});

export const uploadLimiter = rateLimit({
  windowMs: 1 * 60 * 1000,
  max: 10, // 분당 10개 파일
  message: 'Too many uploads'
});
```

### 6.3 파일 업로드 검증

```typescript
// middleware/upload.middleware.ts
import multer from 'multer';
import path from 'path';
import { Request } from 'express';

const storage = multer.memoryStorage();

const fileFilter = (req: Request, file: Express.Multer.File, cb: multer.FileFilterCallback) => {
  const allowedMimes = ['image/jpeg', 'image/png', 'image/webp'];

  if (allowedMimes.includes(file.mimetype)) {
    cb(null, true);
  } else {
    cb(new Error('Invalid file type. Only JPEG, PNG, and WebP are allowed.'));
  }
};

export const upload = multer({
  storage,
  fileFilter,
  limits: {
    fileSize: 10 * 1024 * 1024 // 10MB
  }
});
```

### 6.4 입력 검증 (Zod)

```typescript
// validators/site.validator.ts
import { z } from 'zod';

export const createSiteSchema = z.object({
  body: z.object({
    name: z.string().min(2).max(100),
    type: z.enum(['CONSIGNMENT', 'DELIVERY', 'LUNCHBOX', 'EVENT']),
    address: z.string().min(5).max(200),
    latitude: z.number().min(-90).max(90),
    longitude: z.number().min(-180).max(180),
    contactPerson1: z.string().optional(),
    contactPhone1: z.string().regex(/^010-\d{4}-\d{4}$/).optional(),
  })
});

export const validate = (schema: z.ZodSchema) => {
  return (req: Request, res: Response, next: NextFunction) => {
    try {
      schema.parse({
        body: req.body,
        query: req.query,
        params: req.params
      });
      next();
    } catch (error) {
      if (error instanceof z.ZodError) {
        return res.status(422).json({
          success: false,
          error: {
            code: 'VALIDATION_ERROR',
            details: error.errors
          }
        });
      }
      next(error);
    }
  };
};
```

### 6.5 CORS 설정

```typescript
// config/cors.config.ts
import cors from 'cors';

const whitelist = [
  'http://localhost:3000',
  'http://localhost:19006', // Expo
  'https://admin.dahamvoc.com',
  'https://client.dahamvoc.com'
];

export const corsOptions: cors.CorsOptions = {
  origin: (origin, callback) => {
    if (!origin || whitelist.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true,
  optionsSuccessStatus: 200
};
```

---

## 7. 개발 환경 설정

### 7.1 환경 변수 (.env)

```bash
# 애플리케이션
NODE_ENV=development
PORT=3000
API_URL=http://localhost:3000/api/v1

# 데이터베이스
DATABASE_URL=postgresql://user:password@localhost:5432/daham_voc
MONGODB_URI=mongodb://localhost:27017/daham_voc
REDIS_URL=redis://localhost:6379

# JWT
JWT_SECRET=your-super-secret-key-change-in-production
JWT_EXPIRES_IN=7d
JWT_REFRESH_SECRET=your-refresh-secret
JWT_REFRESH_EXPIRES_IN=30d

# GCP
GCP_PROJECT_ID=daham-voc
GCP_STORAGE_BUCKET=daham-voc-images
GCP_CREDENTIALS_PATH=./gcp-credentials.json

# Kakao
KAKAO_API_KEY=your-kakao-api-key

# Email (선택)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password

# Sentry
SENTRY_DSN=https://your-sentry-dsn

# Rate Limiting
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_MAX_REQUESTS=100
```

### 7.2 Docker Compose (개발 환경)

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: daham_voc
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  mongodb:
    image: mongo:7
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  backend:
    build: ./backend
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/daham_voc
      - MONGODB_URI=mongodb://mongodb:27017/daham_voc
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - mongodb
      - redis
    volumes:
      - ./backend:/app
      - /app/node_modules

volumes:
  postgres_data:
  mongo_data:
```

### 7.3 폴더 구조

```
daham_voc/
├── backend/
│   ├── prisma/
│   │   ├── schema.prisma
│   │   ├── migrations/
│   │   └── seed.ts
│   ├── src/
│   │   ├── config/
│   │   │   ├── database.ts
│   │   │   ├── cors.ts
│   │   │   └── gcp.ts
│   │   ├── middleware/
│   │   │   ├── auth.middleware.ts
│   │   │   ├── rateLimit.middleware.ts
│   │   │   ├── upload.middleware.ts
│   │   │   └── errorHandler.middleware.ts
│   │   ├── validators/
│   │   │   ├── site.validator.ts
│   │   │   ├── menu.validator.ts
│   │   │   └── feedback.validator.ts
│   │   ├── routes/
│   │   │   ├── auth.routes.ts
│   │   │   ├── site.routes.ts
│   │   │   ├── menu.routes.ts
│   │   │   ├── photo.routes.ts
│   │   │   ├── feedback.routes.ts
│   │   │   ├── staff.routes.ts
│   │   │   └── attendance.routes.ts
│   │   ├── controllers/
│   │   │   └── [각 리소스별 컨트롤러]
│   │   ├── services/
│   │   │   ├── auth.service.ts
│   │   │   ├── image.service.ts
│   │   │   ├── gcp.service.ts
│   │   │   └── notification.service.ts
│   │   ├── models/
│   │   │   └── imageMetadata.model.ts (Mongoose)
│   │   ├── utils/
│   │   │   ├── logger.ts
│   │   │   ├── crypto.ts
│   │   │   └── geolocation.ts
│   │   ├── types/
│   │   │   └── express.d.ts
│   │   └── app.ts
│   ├── tests/
│   │   ├── unit/
│   │   └── integration/
│   ├── package.json
│   ├── tsconfig.json
│   ├── .env.example
│   └── Dockerfile
│
├── web/
│   ├── src/
│   │   ├── components/
│   │   ├── pages/
│   │   ├── services/
│   │   ├── store/
│   │   ├── utils/
│   │   └── App.tsx
│   ├── package.json
│   └── vite.config.ts
│
├── mobile/
│   ├── src/
│   │   ├── screens/
│   │   ├── components/
│   │   ├── navigation/
│   │   ├── services/
│   │   ├── store/
│   │   └── App.tsx
│   ├── package.json
│   └── app.json
│
├── docs/
│   ├── api/
│   │   └── swagger.yaml
│   └── architecture/
│
└── README.md
```

---

## 8. 단계별 구현 가이드

### Phase 1: 기본 인프라 구축 (3주)

#### Week 1: 프로젝트 초기화 & DB 설계
```bash
# 1일차: 백엔드 프로젝트 생성
mkdir backend && cd backend
npm init -y
npm install express typescript ts-node @types/node @types/express
npm install prisma @prisma/client mongoose dotenv
npm install bcrypt jsonwebtoken passport passport-jwt
npm install zod helmet cors express-rate-limit
npm install -D @types/bcrypt @types/jsonwebtoken @types/passport-jwt

# Prisma 초기화
npx prisma init

# 2-3일차: schema.prisma 작성 (위 스키마 참고)
# 4일차: Migration 실행
npx prisma migrate dev --name init

# 5일차: Seed 데이터 작성 및 실행
npx prisma db seed
```

**체크리스트:**
- [ ] TypeScript 설정 완료
- [ ] Prisma 스키마 작성
- [ ] PostgreSQL 연결 확인
- [ ] MongoDB 연결 확인
- [ ] Redis 연결 확인
- [ ] 기본 폴더 구조 생성

#### Week 2: 인증 시스템 & 기본 API
```typescript
// 우선순위 작업
1. 인증 미들웨어 구현
2. JWT 발급/검증 로직
3. 회원가입/로그인 API
4. 권한 체크 미들웨어
5. 에러 핸들링 미들웨어
6. 로깅 시스템 구축
```

**체크리스트:**
- [ ] 회원가입 API 완성
- [ ] 로그인 API 완성 (JWT 발급)
- [ ] 토큰 갱신 API
- [ ] 권한별 접근 제어 테스트
- [ ] 에러 핸들링 확인

#### Week 3: 핵심 리소스 CRUD
```typescript
// 구현 순서
1. Sites CRUD API
2. Staff 관리 API (사업장 배정 포함)
3. Menus CRUD API (일괄 생성 포함)
4. Attendance Settings API
```

**체크리스트:**
- [ ] Sites API 완성 및 테스트
- [ ] Staff API 완성 및 테스트
- [ ] Menus API 완성 및 테스트
- [ ] 권한별 접근 테스트
- [ ] Postman Collection 작성

### Phase 2: 이미지 & VOC 시스템 (2주)

#### Week 4: 이미지 업로드 시스템
```typescript
// 구현 작업
1. GCP Storage 연동
2. Sharp를 이용한 이미지 처리
3. 썸네일 자동 생성
4. WebP 변환
5. MongoDB 메타데이터 저장
6. MealPhoto API 구현
```

**체크리스트:**
- [ ] GCP Storage 업로드 성공
- [ ] 이미지 압축 기능 작동
- [ ] 썸네일 생성 확인
- [ ] MongoDB 메타데이터 저장 확인
- [ ] 사진 목록 조회 API 테스트

#### Week 5: VOC 시스템 & 평점
```typescript
// 구현 작업
1. CustomerFeedback CRUD API
2. 별점 시스템 구현
3. 담당자 평균 별점 자동 계산
4. VOC 상태 관리 (미처리/처리중/완료)
5. 관리자 답변 기능
6. 미처리 VOC 알림 로직
```

**체크리스트:**
- [ ] VOC 작성 API 완성
- [ ] 별점 평가 기능 작동
- [ ] 담당자 평균 별점 계산 확인
- [ ] 상태별 필터링 테스트
- [ ] 관리자 답변 기능 테스트

### Phase 3: GPS & 근태 관리 (2주)

#### Week 6: 근태 시스템
```typescript
// 구현 작업
1. Attendance 체크인 API
2. Geofencing 로직 (사업장 반경 검증)
3. 체크아웃 API
4. GPS 좌표 검증
5. 근태 통계 API
```

**체크리스트:**
- [ ] 출근 체크인 성공
- [ ] GPS 좌표 저장 확인
- [ ] Geofencing 작동 테스트
- [ ] 퇴근 체크아웃 성공
- [ ] 근태 내역 조회 확인

#### Week 7: 통계 & 대시보드 API
```typescript
// 구현 작업
1. 대시보드 요약 통계 API
2. VOC 통계 (상태별, 기간별)
3. 평점 통계 (담당자별, 사업장별)
4. 근태 통계 (출근율, 지각률)
5. Redis 캐싱 적용
```

**체크리스트:**
- [ ] 대시보드 API 완성
- [ ] 각종 통계 API 작동
- [ ] Redis 캐싱 적용 확인
- [ ] 성능 테스트 (응답 시간 1초 이내)

### Phase 4: 웹 프론트엔드 (2주)

#### Week 8: 관리자 웹 기본 구조
```bash
# 프로젝트 생성
npm create vite@latest web -- --template react-ts
cd web
npm install antd zustand axios react-query react-router-dom
npm install @types/node
```

**구현 페이지:**
- [ ] 로그인/로그아웃
- [ ] 대시보드 (요약 통계)
- [ ] 사업장 관리 (목록, 등록, 수정)
- [ ] 식단 관리 (일괄 등록 포함)

#### Week 9: 관리자 웹 고급 기능
**구현 페이지:**
- [ ] 사진 갤러리 (필터링, 피드백)
- [ ] VOC 관리 (목록, 답변, 상태 변경)
- [ ] 담당자 관리 (평점, 사업장 배정)
- [ ] 근태 관리 (출근 현황, 통계)
- [ ] 카카오맵 연동 (사업장 위치 표시)

### Phase 5: 모바일 앱 (3주)

#### Week 10: 모바일 앱 기본 구조
```bash
npx react-native init DahamVocApp --template react-native-template-typescript
cd DahamVocApp
npm install react-native-paper react-navigation
npm install @react-navigation/native @react-navigation/stack
npm install axios @react-native-async-storage/async-storage
```

**구현 화면:**
- [ ] 로그인
- [ ] 홈 (담당 사업장 목록)
- [ ] 식단 조회

#### Week 11: 모바일 핵심 기능
```bash
npm install react-native-geolocation-service
npm install react-native-vision-camera
npm install react-native-image-picker
```

**구현 화면:**
- [ ] 출퇴근 체크인 (GPS 연동)
- [ ] 카메라로 배식 사진 촬영
- [ ] 사진 업로드
- [ ] VOC 작성

#### Week 12: 오프라인 모드 & 최적화
```bash
npm install @nozbe/watermelondb
npm install @react-native-firebase/app @react-native-firebase/messaging
```

**구현 기능:**
- [ ] WatermelonDB 설정
- [ ] 오프라인 데이터 저장
- [ ] 온라인 시 동기화
- [ ] FCM 푸시 알림
- [ ] 성능 최적화

### Phase 6: 테스트 & 배포 (1주)

#### Week 13: 통합 테스트 & 배포
```bash
# 백엔드 테스트
npm run test

# 프로덕션 빌드
npm run build

# Docker 이미지 빌드
docker build -t daham-voc-backend .

# GCP Cloud Run 배포
gcloud run deploy daham-voc-api \
  --image gcr.io/daham-voc/backend \
  --platform managed \
  --region asia-northeast3 \
  --allow-unauthenticated
```

**체크리스트:**
- [ ] 백엔드 단위 테스트 통과
- [ ] 통합 테스트 통과
- [ ] 웹 빌드 성공
- [ ] 모바일 APK/IPA 빌드
- [ ] GCP 배포 성공
- [ ] SSL 인증서 적용
- [ ] 모니터링 도구 설정
- [ ] 최종 사용자 테스트

---

## 9. 다음 단계 실행 계획

### 즉시 시작 가능한 작업
1. **백엔드 프로젝트 초기화**
   ```bash
   mkdir daham_voc && cd daham_voc
   mkdir backend && cd backend
   npm init -y
   ```

2. **필수 의존성 설치**
   ```bash
   npm install express typescript prisma
   npx prisma init
   ```

3. **schema.prisma 작성**
   - 위 4.1 섹션의 Prisma 스키마 복사

4. **첫 Migration 실행**
   ```bash
   npx prisma migrate dev --name init
   ```

5. **기본 Express 서버 구축**
   - app.ts 생성
   - 미들웨어 설정
   - 기본 라우트 설정

### 우선순위 작업 (1주차)
- [x] 프로젝트 구조 설계 완료
- [ ] 백엔드 프로젝트 초기화
- [ ] 데이터베이스 연결
- [ ] 첫 API 엔드포인트 작성 (/health)
- [ ] 인증 미들웨어 구현

---

## 10. 참고 자료

### 공식 문서
- [Prisma Documentation](https://www.prisma.io/docs)
- [Express.js Guide](https://expressjs.com/)
- [React Native Documentation](https://reactnative.dev/)
- [Ant Design](https://ant.design/)
- [GCP Cloud Run](https://cloud.google.com/run/docs)

### 추천 학습 자료
- TypeScript Handbook
- JWT Best Practices
- PostgreSQL Performance Tuning
- React Query Guide
- Mobile App Security Best Practices

---

**문서 버전**: 1.0
**최종 수정일**: 2025-10-08
**작성자**: Claude (Anthropic)
