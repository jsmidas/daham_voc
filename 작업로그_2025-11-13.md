# 작업 로그 - 2025-11-13

## 📱 모바일 앱 배포 개선

### 완료된 작업
1. **EAS 빌드 설정 변경** (`mobile/eas.json`)
   - AAB 대신 APK로 빌드되도록 설정
   - Internal Distribution 활성화
   - 회원가입 없이 링크로 다운로드 가능

2. **빌드 완료**
   - 빌드 ID: `a6a737af-cecf-4bca-a204-4e442ff18a8c`
   - 설치 링크: https://expo.dev/accounts/jsmidas/projects/daham-voc/builds/a6a737af-cecf-4bca-a204-4e442ff18a8c
   - APK 직접 다운로드: https://expo.dev/artifacts/eas/mzzUYUmVhsJjQQQ7wC32mh.apk

### 사용 방법
```bash
# 다음 빌드 명령어
cd mobile
eas build --profile preview --platform android
```

---

## 🏢 담당자 관리 화면 - 위탁사업장 표시 문제

### 문제 상황
- 담당자 관리 화면에서 위탁사업장 11개가 표시되지 않음
- 전체 사업장: 220개 (본사/영남 209개 + 위탁 11개)
- 사용자가 209개만 보임

### 근본 원인
**운영 서버(https://api.dahamvoc.co.kr)의 Redis 캐시 문제**
- 로컬 서버: 정상 (8개 그룹 반환)
- 운영 서버: 0개 그룹 반환 (오래된 캐시)

### 완료된 코드 수정

#### 1. 프론트엔드 수정 (`web/src/pages/staff/StaffFormPage.tsx`)

**변경 1: 모든 division 동적 처리**
```typescript
// 이전: HQ, YEONGNAM만 하드코딩
const hqGroups: any[] = [];
const yeongnamGroups: any[] = [];

// 수정: 모든 division 동적 수집
const divisionGroups = new Map<string, any[]>();
groups.forEach((group: any) => {
  const division = group.division || 'OTHER';
  // ...
  divisionGroups.get(division)!.push(treeNode);
});
```

**변경 2: Division 라벨 매핑 추가**
```typescript
const divisionLabels: Record<string, string> = {
  HQ: '본사',
  YEONGNAM: '영남지사',
  CONSIGNMENT: '위탁사업장',  // ← 추가
  OTHER: '기타',
};
```

**변경 3: API 호출 시 limit 명시**
```typescript
// 이전
getSites()

// 수정
getSites({ limit: 1000 })
```

**변경 4: 사업장 타입 한글 표시**
```typescript
const getSiteTypeLabel = (type: string) => {
  const typeLabels: Record<string, string> = {
    CONSIGNMENT: '위탁',
    DELIVERY: '운반급식',
    LUNCHBOX: '도시락',
    EVENT: '행사',
  };
  return typeLabels[type] || type;
};
```

### 🔴 남은 작업 (내일 해야 할 일)

#### 필수: 운영 서버 Redis 캐시 초기화

**방법 1: Railway 대시보드에서 재시작**
1. https://railway.app/dashboard 접속
2. 백엔드 서비스 선택
3. "Restart" 버튼 클릭

**방법 2: Railway CLI 사용**
```bash
railway restart
```

**방법 3: GCP SSH 접속하여 캐시 삭제**
```bash
# GCP에 SSH 접속 후
redis-cli FLUSHDB
```

#### 확인 방법
재시작 후 다음 API를 테스트:
```bash
# 운영 서버 API 확인
curl -H "Authorization: Bearer <TOKEN>" \
  "https://api.dahamvoc.co.kr/api/v1/site-groups"
# → groups 배열이 8개여야 함 (CONSIGNMENT 포함)

curl -H "Authorization: Bearer <TOKEN>" \
  "https://api.dahamvoc.co.kr/api/v1/sites?limit=1000"
# → sites 배열이 220개여야 함
```

#### 브라우저 확인
1. https://admin.dahamvoc.co.kr/staff/new 접속
2. "사업장 배정" 섹션 확인
3. Tree 구조에 다음이 보여야 함:
   ```
   📁 본사 (59개)
   📁 영남지사 (92개)
   📁 위탁사업장 (11개)  ← 이게 보여야 함!
   ```

### 데이터베이스 확인 (참고용)

```bash
# 전체 사업장 수 확인
cd backend
DIRECT_URL="postgresql://postgres.iyussgoqhgzogjvpuxnb:cc956697%25%5E12@aws-1-ap-northeast-2.pooler.supabase.com:5432/postgres" \
npx ts-node -e "import { PrismaClient } from '@prisma/client'; \
const prisma = new PrismaClient(); \
(async () => { \
  const total = await prisma.site.count({ where: { isActive: true, deletedAt: null } }); \
  const consignment = await prisma.site.count({ where: { type: 'CONSIGNMENT', isActive: true, deletedAt: null } }); \
  console.log('전체 사업장:', total); \
  console.log('위탁사업장:', consignment); \
  process.exit(0); \
})();"

# 결과: 전체 220개, 위탁 11개
```

### 위탁사업장 그룹 정보
- **그룹 ID**: `f0e74862-dc53-4a5d-818f-268364d5eb31`
- **그룹명**: "위탁사업장"
- **Division**: `CONSIGNMENT`
- **사업장 수**: 11개
- **사업장 목록**:
  1. 군위늘채움뷔페
  2. 삼원
  3. 경남지오영
  4. 한국산업단지공단
  5. 모아
  6. 아이앤피
  7. 아이팜코리아
  8. 영남지오영
  9. 성신RST
  10. 모래코리아
  11. SAL

---

## 📝 변경된 파일 목록

1. `mobile/eas.json` - APK 빌드 설정
2. `web/src/pages/staff/StaffFormPage.tsx` - 위탁사업장 표시 로직

---

## 🔧 디버깅 정보

### 로컬 서버 (정상)
- URL: http://localhost:3000
- site-groups API: 8개 그룹 반환 ✅
- sites API: 220개 사업장 반환 ✅

### 운영 서버 (문제)
- URL: https://api.dahamvoc.co.kr
- site-groups API: 0개 그룹 반환 ❌
- sites API: 확인 필요
- **원인**: Redis 캐시에 오래된 데이터

---

## 다음 작업 시 체크리스트

- [ ] 운영 서버 재시작 또는 Redis 캐시 초기화
- [ ] API 응답 확인 (8개 그룹, 220개 사업장)
- [ ] 브라우저에서 위탁사업장 표시 확인
- [ ] 담당자에게 위탁사업장 배정 테스트
