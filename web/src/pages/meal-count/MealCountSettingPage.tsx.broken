/**
 * Meal Count Setting Page
 * @description ì‚¬ì—…ì¥ë³„ ì‹ìˆ˜ ì…ë ¥ ë§ˆê°ì‹œê°„ ì„¤ì • í˜ì´ì§€ (ì¬ì„¤ê³„ v2)
 */

import { Button, Space, message, Modal, Form, Switch, TimePicker, Card, Tag, Input, Row, Col, Table, Alert, Divider } from 'antd';
import { CopyOutlined, EditOutlined } from '@ant-design/icons';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { getSites } from '@/api/site.api';
import { getMealCountSetting, upsertMealCountSetting } from '@/api/meal-count.api';
import type { MealCountSetting } from '@/api/meal-count.api';
import { useState, useMemo, useEffect } from 'react';
import dayjs from 'dayjs';
import type { TableRowSelection } from 'antd/es/table/interface';

interface SiteWithSetting {
  siteId: string;
  siteName: string;
  siteType: string;
  division: string;
  setting?: MealCountSetting;
}

const SITE_TYPE_LABELS: Record<string, string> = {
  LUNCHBOX: 'ë„ì‹œë½',
  DELIVERY: 'ìš´ë°˜',
  CONSIGNMENT: 'ìœ„íƒ',
  EVENT: 'ì´ë²¤íŠ¸',
};

const SITE_TYPE_COLORS: Record<string, string> = {
  LUNCHBOX: 'blue',
  DELIVERY: 'green',
  CONSIGNMENT: 'orange',
  EVENT: 'purple',
};

export default function MealCountSettingPage() {
  console.log('ğŸš€ğŸš€ğŸš€ MealCountSettingPage ì»´í¬ë„ŒíŠ¸ ë¡œë“œë¨! (ìµœì‹  ë²„ì „ v2.0) ğŸš€ğŸš€ğŸš€');

  const queryClient = useQueryClient();
  const [modalVisible, setModalVisible] = useState(false);
  const [currentSiteId, setCurrentSiteId] = useState<string | undefined>();
  const [copyMode, setCopyMode] = useState(false);
  const [selectedRowKeys, setSelectedRowKeys] = useState<React.Key[]>([]);
  const [form] = Form.useForm();

  // ë©”ë‰´ ê°œìˆ˜ ìƒíƒœ ê´€ë¦¬
  const [breakfastCount, setBreakfastCount] = useState(1);
  const [lunchCount, setLunchCount] = useState(1);
  const [dinnerCount, setDinnerCount] = useState(1);
  const [supperCount, setSupperCount] = useState(1);

  // ì‚¬ì—…ì¥ ëª©ë¡ ì¡°íšŒ
  const { data: sites, isLoading: sitesLoading } = useQuery({
    queryKey: ['sites'],
    queryFn: () => getSites({ isActive: true }),
  });

  // ëª¨ë“  ì‚¬ì—…ì¥ì˜ ì„¤ì • ì¡°íšŒ
  const { data: allSettings, isLoading: settingsLoading, refetch: refetchSettings } = useQuery({
    queryKey: ['meal-count-settings-all'],
    queryFn: async () => {
      console.log('[MealCountSetting] Fetching all settings...');
      if (!sites?.data?.sites) return {};
      const promises = sites.data.sites.map((site: any) =>
        getMealCountSetting(site.id)
          .then(res => {
            console.log(`[MealCountSetting] Fetched setting for ${site.name}:`, res.data);
            return { siteId: site.id, setting: res.data };
          })
          .catch(() => {
            console.log(`[MealCountSetting] No setting found for ${site.name}`);
            return { siteId: site.id, setting: null };
          })
      );
      const results = await Promise.all(promises);
      const settingsMap: Record<string, MealCountSetting | null> = {};
      results.forEach(r => {
        settingsMap[r.siteId] = r.setting;
      });
      console.log('[MealCountSetting] All settings loaded:', settingsMap);
      return settingsMap;
    },
    enabled: !!sites?.data?.sites,
    staleTime: 0, // í•­ìƒ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    gcTime: 0, // ìºì‹œ ì¦‰ì‹œ ë§Œë£Œ (React Query v5)
    refetchOnMount: 'always', // ë§ˆìš´íŠ¸ ì‹œ í•­ìƒ ë¦¬í”„ë ˆì‹œ
    refetchOnWindowFocus: true, // ìœˆë„ìš° í¬ì»¤ìŠ¤ ì‹œ ë¦¬í”„ë ˆì‹œ
  });

  // ì „ì²´ ì‚¬ì—…ì¥ ë¦¬ìŠ¤íŠ¸ (ì„¤ì • ìœ ë¬´ì™€ ê´€ê³„ì—†ì´)
  const allSitesList = useMemo<SiteWithSetting[]>(() => {
    if (!sites?.data?.sites) return [];
    console.log('[MealCountSetting] Building sites list. allSettings:', allSettings);
    return sites.data.sites.map((site: any) => ({
      siteId: site.id,
      siteName: site.name,
      siteType: site.type,
      division: site.division,
      setting: allSettings?.[site.id] || undefined,
    }));
  }, [sites, allSettings]);

  // ì„¤ì • ì €ì¥ Mutation
  const saveMutation = useMutation({
    mutationFn: async (data: { siteId: string; setting: Partial<MealCountSetting> }) =>
      upsertMealCountSetting(data.siteId, data.setting),
    onSuccess: async (response, variables) => {
      console.log('ğŸ‰ [MealCountSetting] Save successful!');
      console.log('ğŸ“¦ [MealCountSetting] Server response:', response);
      message.success('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');

      // 1. ëª¨ë“  ê´€ë ¨ ì¿¼ë¦¬ ë¬´íš¨í™”
      console.log('ğŸ—‘ï¸ [MealCountSetting] Invalidating queries...');
      await queryClient.invalidateQueries({
        queryKey: ['meal-count-settings-all'],
        refetchType: 'all'
      });

      // 2. ì‘ì€ ì§€ì—° í›„ ê°•ì œ ë¦¬í”„ë ˆì‹œ
      console.log('â³ [MealCountSetting] Waiting for server sync...');
      await new Promise(resolve => setTimeout(resolve, 300));

      // 3. ë‹¤ì‹œ í•œë²ˆ refetch í˜¸ì¶œ
      console.log('ğŸ”„ [MealCountSetting] Refetching data...');
      await refetchSettings();
      console.log('âœ… [MealCountSetting] Refetch completed!');

      // 4. ëª¨ë‹¬ ë‹«ê¸°
      setModalVisible(false);
      form.resetFields();
    },
    onError: (error: any) => {
      console.error('âŒ [MealCountSetting] Save failed:', error);
      message.error(error.message || 'ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    },
  });

  // ì„ íƒí•œ ì‚¬ì—…ì¥ì— ë³µì œ Mutation
  const batchSaveMutation = useMutation({
    mutationFn: async (data: { siteIds: string[]; setting: Partial<MealCountSetting> }) => {
      const promises = data.siteIds.map(siteId =>
        upsertMealCountSetting(siteId, data.setting)
      );
      await Promise.all(promises);
    },
    onSuccess: async (_, variables) => {
      console.log('ğŸ‰ [MealCountSetting] Batch save successful!');
      message.success(`${variables.siteIds.length}ê°œ ì‚¬ì—…ì¥ì— ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤`);

      // 1. ëª¨ë“  ê´€ë ¨ ì¿¼ë¦¬ ë¬´íš¨í™”
      console.log('ğŸ—‘ï¸ [MealCountSetting] Invalidating queries...');
      await queryClient.invalidateQueries({
        queryKey: ['meal-count-settings-all'],
        refetchType: 'all'
      });

      // 2. ì‘ì€ ì§€ì—° í›„ ê°•ì œ ë¦¬í”„ë ˆì‹œ
      console.log('â³ [MealCountSetting] Waiting for server sync...');
      await new Promise(resolve => setTimeout(resolve, 500));

      // 3. ë‹¤ì‹œ í•œë²ˆ refetch í˜¸ì¶œ
      console.log('ğŸ”„ [MealCountSetting] Refetching data...');
      await refetchSettings();
      console.log('âœ… [MealCountSetting] Refetch completed!');

      // 4. ëª¨ë‹¬ ë‹«ê¸°
      setModalVisible(false);
      form.resetFields();
      setSelectedRowKeys([]);
    },
    onError: (error: any) => {
      console.error('âŒ [MealCountSetting] Batch save failed:', error);
      message.error(error.message || 'ì„¤ì • ë³µì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    },
  });

  const handleOpenModal = (siteId?: string, isCopyMode = false) => {
    setCurrentSiteId(siteId);
    setCopyMode(isCopyMode);
    form.resetFields();

    if (siteId && !isCopyMode) {
      // ê°œë³„ ì‚¬ì—…ì¥ ìˆ˜ì •
      const siteData = allSitesList.find(s => s.siteId === siteId);
      const setting = siteData?.setting;

      if (setting) {
        setBreakfastCount(setting.breakfastMenuCount || 1);
        setLunchCount(setting.lunchMenuCount || 1);
        setDinnerCount(setting.dinnerMenuCount || 1);
        setSupperCount(setting.supperMenuCount || 1);

        setTimeout(() => {
          const formValues: any = {
            breakfastDeadline: setting.breakfastDeadline ? dayjs(setting.breakfastDeadline, 'HH:mm') : undefined,
            lunchDeadline: setting.lunchDeadline ? dayjs(setting.lunchDeadline, 'HH:mm') : undefined,
            dinnerDeadline: setting.dinnerDeadline ? dayjs(setting.dinnerDeadline, 'HH:mm') : undefined,
            supperDeadline: setting.supperDeadline ? dayjs(setting.supperDeadline, 'HH:mm') : undefined,
            breakfastMenuCount: setting.breakfastMenuCount || 1,
            lunchMenuCount: setting.lunchMenuCount || 1,
            dinnerMenuCount: setting.dinnerMenuCount || 1,
            supperMenuCount: setting.supperMenuCount || 1,
            allowLateSubmission: setting.allowLateSubmission ?? false,
            isActive: setting.isActive ?? true,
          };

          // ë©”ë‰´ëª… í•„ë“œ ì„¤ì •
          for (let i = 1; i <= 5; i++) {
            formValues[`breakfastMenu${i}Name`] = (setting as any)[`breakfastMenu${i}Name`] || '';
            formValues[`lunchMenu${i}Name`] = (setting as any)[`lunchMenu${i}Name`] || '';
            formValues[`dinnerMenu${i}Name`] = (setting as any)[`dinnerMenu${i}Name`] || '';
            formValues[`supperMenu${i}Name`] = (setting as any)[`supperMenu${i}Name`] || '';
          }

          form.setFieldsValue(formValues);
        }, 0);
      } else {
        setBreakfastCount(1);
        setLunchCount(1);
        setDinnerCount(1);
        setSupperCount(1);
      }
    } else {
      // ì‹ ê·œ ë˜ëŠ” ë³µì œ ëª¨ë“œ
      setBreakfastCount(1);
      setLunchCount(1);
      setDinnerCount(1);
      setSupperCount(1);
      setTimeout(() => {
        form.setFieldsValue({
          breakfastMenuCount: 1,
          lunchMenuCount: 1,
          dinnerMenuCount: 1,
          supperMenuCount: 1,
          allowLateSubmission: false,
          isActive: true,
        });
      }, 0);
    }

    setModalVisible(true);
  };

  const handleSave = async () => {
    console.log('=== handleSave í˜¸ì¶œë¨ ===');
    console.log('copyMode:', copyMode);
    console.log('currentSiteId:', currentSiteId);

    try {
      console.log('ğŸ” Form ìœ íš¨ì„± ê²€ì‚¬ ì‹œì‘...');
      const values = await form.validateFields();
      console.log('âœ… Form validation ì„±ê³µ');
      console.log('Form values:', values);

      const settingData: Partial<MealCountSetting> = {
        breakfastDeadline: values.breakfastDeadline ? values.breakfastDeadline.format('HH:mm') : undefined,
        lunchDeadline: values.lunchDeadline ? values.lunchDeadline.format('HH:mm') : undefined,
        dinnerDeadline: values.dinnerDeadline ? values.dinnerDeadline.format('HH:mm') : undefined,
        supperDeadline: values.supperDeadline ? values.supperDeadline.format('HH:mm') : undefined,
        breakfastMenuCount: parseInt(values.breakfastMenuCount) ?? 0,
        lunchMenuCount: parseInt(values.lunchMenuCount) ?? 0,
        dinnerMenuCount: parseInt(values.dinnerMenuCount) ?? 0,
        supperMenuCount: parseInt(values.supperMenuCount) ?? 0,
        allowLateSubmission: values.allowLateSubmission,
        isActive: values.isActive,
      };

      // ë©”ë‰´ëª… í•„ë“œ ì¶”ê°€
      for (let i = 1; i <= 5; i++) {
        (settingData as any)[`breakfastMenu${i}Name`] = values[`breakfastMenu${i}Name`] || undefined;
        (settingData as any)[`lunchMenu${i}Name`] = values[`lunchMenu${i}Name`] || undefined;
        (settingData as any)[`dinnerMenu${i}Name`] = values[`dinnerMenu${i}Name`] || undefined;
        (settingData as any)[`supperMenu${i}Name`] = values[`supperMenu${i}Name`] || undefined;
      }

      console.log('ğŸ“¦ ì €ì¥í•  ë°ì´í„°:', JSON.stringify(settingData, null, 2));

      if (copyMode) {
        console.log('ğŸ”„ ë³µì œ ëª¨ë“œ ì‹¤í–‰');
        if (selectedRowKeys.length === 0) {
          message.warning('ì‚¬ì—…ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
          return;
        }
        console.log('ğŸš€ batchSaveMutation.mutateAsync í˜¸ì¶œ ì‹œì‘...');
        await batchSaveMutation.mutateAsync({
          siteIds: selectedRowKeys as string[],
          setting: settingData,
        });
        console.log('âœ… batchSaveMutation.mutateAsync ì™„ë£Œ');
      } else if (currentSiteId) {
        console.log('ğŸ’¾ ê°œë³„ ì €ì¥ ëª¨ë“œ ì‹¤í–‰ - siteId:', currentSiteId);
        console.log('ğŸš€ saveMutation.mutateAsync í˜¸ì¶œ ì‹œì‘...');

        try {
          const result = await saveMutation.mutateAsync({ siteId: currentSiteId, setting: settingData });
          console.log('âœ… saveMutation.mutateAsync ì™„ë£Œ - ê²°ê³¼:', result);
        } catch (mutationError) {
          console.error('âŒ saveMutation.mutateAsync ì—ëŸ¬:', mutationError);
          throw mutationError;
        }
      } else {
        console.warn('âš ï¸ currentSiteIdê°€ ì—†ìŠµë‹ˆë‹¤!');
      }
    } catch (error) {
      console.error('âŒ Validation ë˜ëŠ” ì €ì¥ ì‹¤íŒ¨:', error);
      if (error instanceof Error) {
        console.error('  ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
        console.error('  ìŠ¤íƒ:', error.stack);
      }
    }
  };

  const rowSelection: TableRowSelection<SiteWithSetting> = {
    selectedRowKeys,
    onChange: (selectedKeys: React.Key[]) => {
      setSelectedRowKeys(selectedKeys);
    },
    getCheckboxProps: (record: SiteWithSetting) => ({
      name: record.siteName,
    }),
  };

  const columns = [
    {
      title: 'ì‚¬ì—…ì¥',
      dataIndex: 'siteName',
      key: 'siteName',
      width: 200,
      render: (_: any, record: SiteWithSetting) => (
        <Space direction="vertical" size={0}>
          <span style={{ fontWeight: 500 }}>{record.siteName}</span>
          <span style={{ fontSize: 12, color: '#999' }}>{record.division}</span>
        </Space>
      ),
    },
    {
      title: 'íƒ€ì…',
      key: 'type',
      width: 100,
      render: (_: any, record: SiteWithSetting) => (
        <Tag color={SITE_TYPE_COLORS[record.siteType]}>
          {SITE_TYPE_LABELS[record.siteType] || record.siteType}
        </Tag>
      ),
    },
    {
      title: 'ì¡°ì‹ ë§ˆê°',
      key: 'breakfast',
      width: 150,
      render: (_: any, record: SiteWithSetting) => (
        record.setting?.breakfastDeadline ? (
          <Tag color="blue">ì „ë‚  {record.setting.breakfastDeadline}</Tag>
        ) : (
          <span style={{ color: '#999' }}>ë¯¸ì„¤ì •</span>
        )
      ),
    },
    {
      title: 'ì¤‘ì‹ ë§ˆê°',
      key: 'lunch',
      width: 150,
      render: (_: any, record: SiteWithSetting) => (
        record.setting?.lunchDeadline ? (
          <Tag color="green">ë‹¹ì¼ {record.setting.lunchDeadline}</Tag>
        ) : (
          <span style={{ color: '#999' }}>ë¯¸ì„¤ì •</span>
        )
      ),
    },
    {
      title: 'ì„ì‹ ë§ˆê°',
      key: 'dinner',
      width: 150,
      render: (_: any, record: SiteWithSetting) => (
        record.setting?.dinnerDeadline ? (
          <Tag color="orange">ë‹¹ì¼ {record.setting.dinnerDeadline}</Tag>
        ) : (
          <span style={{ color: '#999' }}>ë¯¸ì„¤ì •</span>
        )
      ),
    },
    {
      title: 'ì•¼ì‹ ë§ˆê°',
      key: 'supper',
      width: 150,
      render: (_: any, record: SiteWithSetting) => (
        record.setting?.supperDeadline ? (
          <Tag color="purple">ë‹¹ì¼ {record.setting.supperDeadline}</Tag>
        ) : (
          <span style={{ color: '#999' }}>ë¯¸ì„¤ì •</span>
        )
      ),
    },
    {
      title: 'ë©”ë‰´ ê°œìˆ˜',
      key: 'menuCount',
      width: 200,
      render: (_: any, record: SiteWithSetting) => {
        if (!record.setting) return <span style={{ color: '#999' }}>ë¯¸ì„¤ì •</span>;
        return (
          <Space size={4}>
            <Tag color={record.setting.breakfastMenuCount === 0 ? 'default' : undefined}>ì¡° {record.setting.breakfastMenuCount}ê°œ</Tag>
            <Tag color={record.setting.lunchMenuCount === 0 ? 'default' : undefined}>ì¤‘ {record.setting.lunchMenuCount}ê°œ</Tag>
            <Tag color={record.setting.dinnerMenuCount === 0 ? 'default' : undefined}>ì„ {record.setting.dinnerMenuCount}ê°œ</Tag>
            <Tag color={record.setting.supperMenuCount === 0 ? 'default' : undefined}>ì•¼ {record.setting.supperMenuCount}ê°œ</Tag>
          </Space>
        );
      },
    },
    {
      title: 'ìƒíƒœ',
      key: 'status',
      width: 120,
      render: (_: any, record: SiteWithSetting) => {
        if (!record.setting) return <Tag>ë¯¸ì„¤ì •</Tag>;
        return (
          <Space>
            {record.setting.isActive ? <Tag color="green">í™œì„±</Tag> : <Tag>ë¹„í™œì„±</Tag>}
            {record.setting.allowLateSubmission && <Tag color="orange">ë§ˆê°í›„í—ˆìš©</Tag>}
          </Space>
        );
      },
    },
    {
      title: 'ì‘ì—…',
      key: 'actions',
      width: 100,
      fixed: 'right' as const,
      render: (_: any, record: SiteWithSetting) => (
        <Button
          type="link"
          size="small"
          icon={<EditOutlined />}
          onClick={() => handleOpenModal(record.siteId)}
        >
          {record.setting ? 'ìˆ˜ì •' : 'ì„¤ì •'}
        </Button>
      ),
    },
  ];

  const settingsCount = allSitesList.filter(s => s.setting).length;

  // ë©”ë‰´ëª… ì…ë ¥ í•„ë“œ ë Œë”ë§
  const renderMenuNameFields = (mealType: 'breakfast' | 'lunch' | 'dinner' | 'supper', count: number) => {
    const fields = [];
    for (let i = 1; i <= count; i++) {
      fields.push(
        <Col span={12} key={i}>
          <Form.Item
            label={`ë©”ë‰´ ${i}`}
            name={`${mealType}Menu${i}Name`}
          >
            <Input placeholder={`ë©”ë‰´ ${i} ì´ë¦„ (ì˜ˆ: ë°±ë°˜, ëˆê¹ŒìŠ¤ ë“±)`} />
          </Form.Item>
        </Col>
      );
    }
    return fields;
  };

  return (
    <div>
      {/* í—¤ë” */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>
        <h1 style={{ margin: 0 }}>ì‹ìˆ˜ ë§ˆê°ì‹œê°„ ì„¤ì •</h1>
      </div>

      {/* ì•ˆë‚´ ë©”ì‹œì§€ */}
      <Alert
        message="ë§ˆê°ì‹œê°„ ì„¤ì • ì•ˆë‚´"
        description={
          <ul style={{ marginBottom: 0, paddingLeft: 20 }}>
            <li><strong>ì¡°ì‹:</strong> ì „ë‚  ì €ë…ì— ë§ˆê° (ì˜ˆ: ì „ë‚  20:00)</li>
            <li><strong>ì¤‘ì‹/ì„ì‹:</strong> ë‹¹ì¼ ë§ˆê° (ì˜ˆ: ë‹¹ì¼ 10:00, 15:00)</li>
            <li><strong>ë©”ë‰´ëª…:</strong> ë©”ë‰´ ê°œìˆ˜ë¥¼ ì„¤ì •í•˜ë©´ ê° ë©”ë‰´ì˜ ì´ë¦„ì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
            <li><strong>ì¼ê´„ ì ìš©:</strong> ì‚¬ì—…ì¥ì„ ì„ íƒí•˜ê³  "ì„ íƒí•œ ì‚¬ì—…ì¥ì— ì„¤ì • ë³µì œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</li>
          </ul>
        }
        type="info"
        showIcon
        style={{ marginBottom: 16 }}
      />

      {/* ì„¤ì • ëª©ë¡ í…Œì´ë¸” */}
      <Card
        title={
          <Space>
            <span>ì „ì²´ ì‚¬ì—…ì¥ ({allSitesList.length}ê°œ)</span>
            <Tag color="green">ì„¤ì •ë¨ {settingsCount}ê°œ</Tag>
            <Tag color="default">ë¯¸ì„¤ì • {allSitesList.length - settingsCount}ê°œ</Tag>
          </Space>
        }
        extra={
          <Space>
            {selectedRowKeys.length > 0 && (
              <span style={{ color: '#1890ff' }}>
                {selectedRowKeys.length}ê°œ ì„ íƒë¨
              </span>
            )}
            <Button
              type="primary"
              icon={<CopyOutlined />}
              onClick={() => handleOpenModal(undefined, true)}
              disabled={selectedRowKeys.length === 0}
            >
              ì„ íƒí•œ ì‚¬ì—…ì¥ì— ì„¤ì • ë³µì œ
            </Button>
          </Space>
        }
      >
        <Table
          rowSelection={rowSelection}
          columns={columns}
          dataSource={allSitesList}
          rowKey="siteId"
          loading={sitesLoading || settingsLoading}
          pagination={{
            pageSize: 20,
            showSizeChanger: true,
            showTotal: (total) => `ì´ ${total}ê°œ`,
          }}
          scroll={{ x: 1400 }}
        />
      </Card>

      {/* ì„¤ì • ëª¨ë‹¬ */}
      <Modal
        title={
          copyMode
            ? `ì„ íƒí•œ ${selectedRowKeys.length}ê°œ ì‚¬ì—…ì¥ì— ì„¤ì • ë³µì œ`
            : 'ë§ˆê°ì‹œê°„ ì„¤ì •'
        }
        open={modalVisible}
        onOk={handleSave}
        onCancel={() => {
          setModalVisible(false);
          form.resetFields();
        }}
        confirmLoading={saveMutation.isPending || batchSaveMutation.isPending}
        okText={copyMode ? `${selectedRowKeys.length}ê°œ ì‚¬ì—…ì¥ì— ì ìš©` : 'ì €ì¥'}
        cancelText="ì·¨ì†Œ"
        width={900}
      >
        {copyMode && (
          <Alert
            message="ì„¤ì • ë³µì œ ì•ˆë‚´"
            description={
              <div>
                <p>ì„ íƒí•œ <strong>{selectedRowKeys.length}ê°œ ì‚¬ì—…ì¥</strong>ì— ë™ì¼í•œ ì„¤ì •ì´ ì ìš©ë©ë‹ˆë‹¤:</p>
                <div style={{ maxHeight: 100, overflow: 'auto', backgroundColor: '#f5f5f5', padding: 8, borderRadius: 4 }}>
                  {selectedRowKeys.map(key => {
                    const site = allSitesList.find(s => s.siteId === key);
                    return site ? <Tag key={key} style={{ margin: 2 }}>{site.siteName}</Tag> : null;
                  })}
                </div>
              </div>
            }
            type="warning"
            showIcon
            style={{ marginBottom: 16 }}
          />
        )}

        <Form form={form} layout="vertical">
          {/* ë§ˆê° ì‹œê°„ ì„¤ì • */}
          <Card title="ë§ˆê° ì‹œê°„ ì„¤ì •" size="small" style={{ marginBottom: 16 }}>
            <Row gutter={16}>
              <Col span={8}>
                <Form.Item
                  label={
                    <Space>
                      <span>ì¡°ì‹ ë§ˆê°</span>
                      <Tag color="blue" style={{ fontSize: 11 }}>ì „ë‚ </Tag>
                    </Space>
                  }
                  name="breakfastDeadline"
                  tooltip="ì¡°ì‹ì€ ì „ë‚  ì €ë…ì— ë§ˆê°ë©ë‹ˆë‹¤"
                >
                  <TimePicker style={{ width: '100%' }} format="HH:mm" minuteStep={10} placeholder="ì˜ˆ: 20:00" />
                </Form.Item>
              </Col>
              <Col span={8}>
                <Form.Item
                  label={
                    <Space>
                      <span>ì¤‘ì‹ ë§ˆê°</span>
                      <Tag color="green" style={{ fontSize: 11 }}>ë‹¹ì¼</Tag>
                    </Space>
                  }
                  name="lunchDeadline"
                  tooltip="ì¤‘ì‹ì€ ë‹¹ì¼ ì˜¤ì „ì— ë§ˆê°ë©ë‹ˆë‹¤"
                >
                  <TimePicker style={{ width: '100%' }} format="HH:mm" minuteStep={10} placeholder="ì˜ˆ: 10:00" />
                </Form.Item>
              </Col>
              <Col span={8}>
                <Form.Item
                  label={
                    <Space>
                      <span>ì„ì‹ ë§ˆê°</span>
                      <Tag color="orange" style={{ fontSize: 11 }}>ë‹¹ì¼</Tag>
                    </Space>
                  }
                  name="dinnerDeadline"
                  tooltip="ì„ì‹ì€ ë‹¹ì¼ ì˜¤í›„ì— ë§ˆê°ë©ë‹ˆë‹¤"
                >
                  <TimePicker style={{ width: '100%' }} format="HH:mm" minuteStep={10} placeholder="ì˜ˆ: 15:00" />
                </Form.Item>
              </Col>
              <Col span={8}>
                <Form.Item
                  label={
                    <Space>
                      <span>ì•¼ì‹ ë§ˆê°</span>
                      <Tag color="purple" style={{ fontSize: 11 }}>ë‹¹ì¼</Tag>
                    </Space>
                  }
                  name="supperDeadline"
                  tooltip="ì•¼ì‹ì€ ë‹¹ì¼ ì €ë…ì— ë§ˆê°ë©ë‹ˆë‹¤"
                >
                  <TimePicker style={{ width: '100%' }} format="HH:mm" minuteStep={10} placeholder="ì˜ˆ: 18:00" />
                </Form.Item>
              </Col>
            </Row>
          </Card>

          {/* ì¡°ì‹ ë©”ë‰´ ì„¤ì • */}
          <Card title="ì¡°ì‹ ë©”ë‰´ ì„¤ì •" size="small" style={{ marginBottom: 16 }}>
            <Row gutter={16}>
              <Col span={24}>
                <Form.Item label="ë©”ë‰´ ê°œìˆ˜" name="breakfastMenuCount" rules={[{ required: true }]}>
                  <Input
                    type="number"
                    min={0}
                    max={5}
                    suffix="ê°œ"
                    onChange={(e) => setBreakfastCount(Math.min(5, Math.max(0, parseInt(e.target.value) || 0)))}
                  />
                </Form.Item>
              </Col>
              {breakfastCount > 0 && renderMenuNameFields('breakfast', breakfastCount)}
            </Row>
          </Card>

          {/* ì¤‘ì‹ ë©”ë‰´ ì„¤ì • */}
          <Card title="ì¤‘ì‹ ë©”ë‰´ ì„¤ì •" size="small" style={{ marginBottom: 16 }}>
            <Row gutter={16}>
              <Col span={24}>
                <Form.Item label="ë©”ë‰´ ê°œìˆ˜" name="lunchMenuCount" rules={[{ required: true }]}>
                  <Input
                    type="number"
                    min={0}
                    max={5}
                    suffix="ê°œ"
                    onChange={(e) => setLunchCount(Math.min(5, Math.max(0, parseInt(e.target.value) || 0)))}
                  />
                </Form.Item>
              </Col>
              {lunchCount > 0 && renderMenuNameFields('lunch', lunchCount)}
            </Row>
          </Card>

          {/* ì„ì‹ ë©”ë‰´ ì„¤ì • */}
          <Card title="ì„ì‹ ë©”ë‰´ ì„¤ì •" size="small" style={{ marginBottom: 16 }}>
            <Row gutter={16}>
              <Col span={24}>
                <Form.Item label="ë©”ë‰´ ê°œìˆ˜" name="dinnerMenuCount" rules={[{ required: true }]}>
                  <Input
                    type="number"
                    min={0}
                    max={5}
                    suffix="ê°œ"
                    onChange={(e) => setDinnerCount(Math.min(5, Math.max(0, parseInt(e.target.value) || 0)))}
                  />
                </Form.Item>
              </Col>
              {dinnerCount > 0 && renderMenuNameFields('dinner', dinnerCount)}
            </Row>
          </Card>

          {/* ì•¼ì‹ ë©”ë‰´ ì„¤ì • */}
          <Card title="ì•¼ì‹ ë©”ë‰´ ì„¤ì •" size="small" style={{ marginBottom: 16 }}>
            <Row gutter={16}>
              <Col span={24}>
                <Form.Item label="ë©”ë‰´ ê°œìˆ˜" name="supperMenuCount" rules={[{ required: true }]}>
                  <Input
                    type="number"
                    min={0}
                    max={5}
                    suffix="ê°œ"
                    onChange={(e) => setSupperCount(Math.min(5, Math.max(0, parseInt(e.target.value) || 0)))}
                  />
                </Form.Item>
              </Col>
              {supperCount > 0 && renderMenuNameFields('supper', supperCount)}
            </Row>
          </Card>

          {/* ê¸°íƒ€ ì„¤ì • */}
          <Card title="ê¸°íƒ€ ì„¤ì •" size="small">
            <Row gutter={16}>
              <Col span={12}>
                <Form.Item label="ë§ˆê° í›„ ì…ë ¥ í—ˆìš©" name="allowLateSubmission" valuePropName="checked">
                  <Switch checkedChildren="í—ˆìš©" unCheckedChildren="ë¶ˆí—ˆ" />
                </Form.Item>
              </Col>
              <Col span={12}>
                <Form.Item label="ì„¤ì • í™œì„±í™”" name="isActive" valuePropName="checked">
                  <Switch checkedChildren="í™œì„±" unCheckedChildren="ë¹„í™œì„±" />
                </Form.Item>
              </Col>
            </Row>
          </Card>
        </Form>
      </Modal>
    </div>
  );
}
