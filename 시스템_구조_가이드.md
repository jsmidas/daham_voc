# Daham VOC 시스템 구조 가이드

## 📋 개요

이 문서는 Daham VOC 시스템의 전체 구조와 역할 기반 화면 구성을 설명합니다.

---

## 🏗️ 시스템 플랫폼 구성

### 1. 플랫폼 구조 (3계층)

```
┌─────────────────────────────────────────────────────────┐
│                  Daham VOC System                       │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  📱 Mobile App (현장/고객사용)                          │
│  ├─ React Native (Expo)                                 │
│  ├─ 대상: SITE_STAFF, DELIVERY_DRIVER, CLIENT          │
│  └─ 기능: 출퇴근, 배식사진, VOC, 식수입력                │
│                                                          │
│  🖥️ Web (관리자용)                                      │
│  ├─ React + Vite + Ant Design                           │
│  ├─ 대상: SUPER_ADMIN, HQ_ADMIN, YEONGNAM_ADMIN,       │
│  │         GROUP_MANAGER, SITE_MANAGER                  │
│  └─ 기능: 사업장관리, 담당자관리, 통계, VOC답변          │
│                                                          │
│  🔧 Backend API                                          │
│  ├─ Express.js + PostgreSQL + Redis + MongoDB          │
│  ├─ RESTful API (/api/v1/*)                            │
│  └─ JWT 인증 + RBAC 권한 관리                           │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 👥 사용자 역할 및 플랫폼

### 역할 분류 (2개 대분류, 8개 세부 역할)

#### A. 다함 내부 담당자

**1. 관리자 (웹 사용)**
```
SUPER_ADMIN
├─ 전체 시스템 관리
├─ 모든 부문 데이터 접근
└─ 담당자 생성/삭제 권한

HQ_ADMIN / YEONGNAM_ADMIN
├─ 부문별 데이터 관리 (본사/영남)
├─ 사업장 그룹 생성/삭제
└─ 부문 내 담당자 조회

GROUP_MANAGER
├─ 그룹(도시락/운반급식 등) 관리
├─ 그룹 내 사업장 생성/수정
└─ 담당자 배정

SITE_MANAGER
├─ 복수 사업장 관리
├─ 사업장별 데이터 조회
└─ 식단표 업로드
```

**2. 현장 담당자 (모바일 앱 사용)**
```
SITE_STAFF
├─ 단일/복수 사업장 담당
├─ 출퇴근 체크
├─ 배식/잔반 사진 업로드
├─ VOC 작성/조회
└─ 식단표 조회

DELIVERY_DRIVER
├─ 복수 사업장 배송
├─ 출퇴근 체크
├─ 배식/잔반 사진 업로드 (순회)
└─ VOC 작성/조회
```

#### B. 고객사 담당자 (모바일 앱 사용)

```
CLIENT
├─ 식수 인원 입력 (조식/중식/석식)
├─ 식단표 조회
├─ VOC 작성/조회
├─ 배식 사진에 평점
└─ 관리자 답변 확인
```

---

## 🎨 화면 및 기능 매트릭스

### 1. 모바일 앱 화면

| 화면/기능 | SITE_STAFF | DELIVERY_DRIVER | CLIENT |
|-----------|------------|-----------------|--------|
| **홈 화면** | ✅ | ✅ | ✅ |
| **사업장 선택** | 복수시 ✅ | ✅ | ❌ (자동) |
| **출퇴근 체크** | ✅ | ✅ | ❌ |
| **배식 사진 업로드** | ✅ | ✅ | ❌ |
| **식단표 조회** | ✅ | ✅ | ✅ |
| **VOC 작성** | ✅ | ✅ | ✅ |
| **VOC 조회** | ✅ 본인+담당 | ✅ 본인+담당 | ✅ 본인만 |
| **식수 인원 입력** | ❌ | ❌ | ✅ (미구현) |
| **마이페이지** | ✅ | ✅ | ✅ |

### 2. 웹 관리자 화면

| 페이지/기능 | SUPER_ADMIN | HQ_ADMIN | YEONGNAM_ADMIN | GROUP_MANAGER | SITE_MANAGER |
|-------------|-------------|----------|----------------|---------------|--------------|
| **대시보드** | ✅ 전체 | ✅ 본사 | ✅ 영남 | ✅ 그룹 | ✅ 담당 |
| **사업장 관리** | ✅ CRUD | ✅ CRUD | ✅ CRUD | ✅ CRUD | ✅ 조회/수정 |
| **사업장 그룹** | ✅ CRUD | ✅ CRUD | ✅ CRUD | ✅ 조회/수정 | ❌ |
| **담당자 관리** | ✅ CRUD | ✅ 조회 | ✅ 조회 | ✅ 조회 | ✅ 조회 |
| **식단 관리** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **배식 사진** | ✅ | ✅ | ✅ | ✅ | ✅ |
| **VOC 관리** | ✅ 답변 | ✅ 답변 | ✅ 답변 | ✅ 답변 | ✅ 답변 |
| **근태 관리** | ✅ 전체 | ✅ 본사 | ✅ 영남 | ✅ 그룹 | ✅ 담당 |
| **통계 조회** | ✅ 전체 | ✅ 본사 | ✅ 영남 | ✅ 그룹 | ✅ 담당 |
| **식수 현황** | ✅ (미구현) | ✅ (미구현) | ✅ (미구현) | ✅ (미구현) | ✅ (미구현) |

---

## 🔐 권한 기반 데이터 접근

### 사업장 선택 로직

```typescript
// 사업장 선택 패턴
const currentSiteId = user?.siteId || selectedSiteId;

/**
 * - SITE_STAFF (단일 사업장): user.siteId 고정
 * - SITE_MANAGER (복수 사업장): selectedSiteId 선택
 * - DELIVERY_DRIVER (복수 사업장): selectedSiteId 선택
 * - CLIENT: user.siteId 고정
 */
```

### 데이터 필터링 예시

```typescript
// 사업장 목록 조회 시
async function getSites(userId: string) {
  const user = await getUserWithRole(userId);

  switch (user.role) {
    case 'SUPER_ADMIN':
      // 모든 사업장
      return allSites;

    case 'HQ_ADMIN':
      // 본사 사업장만
      return sites.filter(s => s.division === 'HQ');

    case 'YEONGNAM_ADMIN':
      // 영남 사업장만
      return sites.filter(s => s.division === 'YEONGNAM');

    case 'SITE_MANAGER':
    case 'SITE_STAFF':
    case 'DELIVERY_DRIVER':
      // 할당된 사업장만
      return user.staff.staffSites.map(ss => ss.site);

    case 'CLIENT':
      // 자신의 사업장만
      return [sites.find(s => s.id === user.siteId)];
  }
}
```

---

## 📱 모바일 앱 네비게이션 구조

### Bottom Tab Navigator

```
┌─────────────────────────────────────────────────────────┐
│  [홈]  [출퇴근]  [배식사진]  [식단표]  [VOC]  [마이]   │ ← SITE_STAFF
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│  [홈]  [출퇴근]  [배식사진]  [식단표]  [VOC]  [마이]   │ ← DELIVERY_DRIVER
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│  [홈]  [식수입력]  [식단표]  [VOC]  [마이]             │ ← CLIENT
└─────────────────────────────────────────────────────────┘
```

### 역할별 탭 표시

```typescript
// AppNavigator.tsx
function MainTabs() {
  const { user } = useAuthStore();
  const shouldShowAttendance = user?.role !== 'CLIENT';
  const shouldShowMealCount = user?.role === 'CLIENT';

  return (
    <Tab.Navigator>
      <Tab.Screen name="HomeTab" component={HomeScreen} />

      {/* 출퇴근 - CLIENT 제외 */}
      {shouldShowAttendance && (
        <Tab.Screen name="AttendanceTab" component={AttendanceScreen} />
      )}

      {/* 배식 사진 - CLIENT 제외 */}
      {shouldShowAttendance && (
        <Tab.Screen name="MealPhotoTab" component={MealPhotoScreen} />
      )}

      {/* 식수 입력 - CLIENT만 */}
      {shouldShowMealCount && (
        <Tab.Screen name="MealCountTab" component={MealCountScreen} />
      )}

      {/* 공통 */}
      <Tab.Screen name="MenuTab" component={MenuScreen} />
      <Tab.Screen name="VOCTab" component={VOCScreen} />
      <Tab.Screen name="MyTab" component={MyScreen} />
    </Tab.Navigator>
  );
}
```

---

## 🔄 API 엔드포인트 구조

### Backend API 매핑

```
/api/v1
├─ /auth              # 인증
│  ├─ POST /login
│  ├─ POST /register
│  ├─ GET /me
│  └─ PUT /password
│
├─ /sites             # 사업장 관리
│  ├─ GET /           # 목록 (권한별 필터링)
│  ├─ POST /          # 생성 (ADMIN만)
│  ├─ GET /:id        # 상세
│  ├─ PUT /:id        # 수정
│  └─ DELETE /:id     # 삭제
│
├─ /site-groups       # 사업장 그룹
│  ├─ GET /
│  ├─ POST /
│  ├─ PUT /:id
│  └─ DELETE /:id
│
├─ /menus             # 식단 관리
│  ├─ GET /           # 목록
│  ├─ POST /          # 업로드
│  └─ DELETE /:id
│
├─ /weekly-menu-templates  # 주간 식단표
│  ├─ GET /           # 주차별 조회
│  ├─ POST /          # 업로드
│  └─ DELETE /:id
│
├─ /meal-photos       # 배식 사진
│  ├─ GET /daily      # 일일 조회
│  ├─ GET /weekly     # 주간 조회
│  ├─ POST /bulk      # 일괄 업로드
│  └─ DELETE /:id
│
├─ /feedbacks         # VOC
│  ├─ GET /           # 목록 (권한별)
│  ├─ POST /          # 작성
│  ├─ PUT /:id/reply  # 답변 (ADMIN)
│  └─ PUT /:id/status # 상태 변경
│
├─ /attendances       # 근태
│  ├─ POST /check-in
│  ├─ POST /:id/check-out
│  ├─ GET /today
│  ├─ GET /table      # 표 형식
│  └─ GET /statistics
│
├─ /staff             # 담당자 관리
│  ├─ GET /
│  ├─ POST /          # SUPER_ADMIN만
│  ├─ PUT /:id
│  └─ DELETE /:id     # SUPER_ADMIN만
│
├─ /meal-counts       # 식수 관리 (미구현)
│  ├─ GET /           # 조회
│  ├─ POST /          # 입력 (CLIENT)
│  ├─ PUT /:id        # 수정
│  └─ GET /settings   # 마감 설정
│
└─ /dashboard         # 대시보드
   ├─ GET /summary    # 요약 통계
   └─ GET /recent     # 최근 활동
```

---

## 🎯 주요 비즈니스 로직

### 1. 사업장 선택 동기화

**구현 위치**: `mobile/src/store/authStore.ts`

```typescript
interface AuthState {
  user: User | null;
  selectedSiteId: string | null;      // 글로벌 선택된 사업장
  availableSites: Site[];             // 선택 가능한 사업장 목록
  setSelectedSite: (siteId: string) => Promise<void>;
}

// AsyncStorage에 영속화
persist(
  (set) => ({ ... }),
  {
    name: 'auth-storage',
    storage: createJSONStorage(() => AsyncStorage),
  }
)
```

**사용 패턴**:
- `HomeScreen`: `<SiteSelector />` 표시 (복수 사업장인 경우)
- 다른 화면: `const currentSiteId = user?.siteId || selectedSiteId`

### 2. GPS 검증 (Geofencing)

**사업장 반경 체크**: 30m

```typescript
// utils/geofencing.util.ts
function checkGeofence(
  userLat: number,
  userLng: number,
  siteLat: number,
  siteLng: number,
  radius: number = 30
): boolean {
  const distance = calculateDistance(userLat, userLng, siteLat, siteLng);
  return distance <= radius;
}
```

**적용 기능**:
- ✅ 출퇴근 체크
- ✅ 배식 사진 업로드

### 3. 식수 입력 마감 체크 (미구현)

```typescript
// 조리 시작 24시간 전 마감
function isDeadlinePassed(
  mealDate: Date,
  mealType: MealType,
  setting: MealCountSetting
): boolean {
  const cookingStartTime = getCookingStartTime(mealType, setting);
  const deadlineTime = subHours(cookingStartTime, setting.deadlineHoursBefore);
  return new Date() > deadlineTime;
}
```

---

## 📊 데이터 흐름 예시

### 예시 1: 배식 사진 업로드

```
[모바일 앱 - SITE_STAFF]
1. 사진 촬영 (expo-image-picker)
2. GPS 좌표 획득 (expo-location)
3. 사업장 반경 체크 (30m)
4. 이미지 압축 (선택적)
5. POST /api/v1/meal-photos/bulk
   - siteId: currentSiteId
   - mealType: 'LUNCH'
   - photoType: 'SERVING'
   - latitude, longitude
   - imageUrl

[Backend API]
6. JWT 토큰 검증 (authMiddleware)
7. 권한 확인 (SITE_STAFF, DELIVERY_DRIVER만)
8. GPS 검증 (geofencing.util)
9. 이미지 업로드 (GCP Storage)
10. DB 저장 (MealPhoto)
11. 응답 반환

[웹 관리자]
12. GET /api/v1/meal-photos/daily
13. 사진 목록 표시
14. 관리자 피드백 작성 가능
```

### 예시 2: VOC 작성 및 답변

```
[모바일 앱 - CLIENT]
1. VOC 작성 화면
2. 사업장 자동 선택 (user.siteId)
3. 내용, 별점, 끼니, 사진 첨부
4. POST /api/v1/feedbacks
   - siteId: user.siteId
   - authorType: 'CLIENT'
   - rating: 5
   - mealType: 'LUNCH'
   - images: [...]

[Backend API]
5. 저장 (CustomerFeedback + FeedbackImage)
6. 상태: PENDING

[웹 관리자 - SITE_MANAGER]
7. GET /api/v1/feedbacks (담당 사업장만)
8. VOC 목록 확인
9. PUT /api/v1/feedbacks/:id/reply
   - adminReply: "답변 내용"
10. 상태: RESOLVED

[모바일 앱 - CLIENT]
11. VOC 목록 조회
12. 관리자 답변 확인
```

---

## 🚀 미구현 기능 (현재 상태)

### Phase 1: 식수 관리 (우선순위 높음)

**DB**: ✅ 완료
- MealCountSetting 모델
- MealCount 모델

**Backend API**: ❌ 미구현
```
필요한 엔드포인트:
- POST /api/v1/meal-counts        # 식수 입력 (CLIENT)
- GET /api/v1/meal-counts          # 조회 (권한별)
- PUT /api/v1/meal-counts/:id      # 수정
- GET /api/v1/meal-counts/settings # 마감 설정 조회
- PUT /api/v1/meal-counts/settings # 마감 설정 수정 (ADMIN)
```

**모바일 앱**: ❌ 미구현
```
필요한 화면:
- MealCountScreen.tsx              # CLIENT용 식수 입력 화면
  ├─ 날짜 선택 (캘린더)
  ├─ 끼니 선택 (조식/중식/석식)
  ├─ 인원수 입력
  ├─ 마감 시간 표시
  └─ 입력 내역 조회
```

**웹 관리자**: ❌ 미구현
```
필요한 페이지:
- MealCountManagementPage.tsx     # 식수 현황 조회
  ├─ 사업장별 식수 현황
  ├─ 미입력 알림
  ├─ 식수 수정 (긴급)
  └─ 통계 그래프
```

### Phase 2: 알림 시스템

- ❌ VOC 알림 (FCM 푸시)
- ❌ 식수 미입력 알림
- ❌ 근태 이상 알림

### Phase 3: 배포 인프라

- ❌ Docker 컨테이너화
- ❌ CI/CD 파이프라인
- ❌ GCP Cloud Run 배포
- ❌ 도메인 연결 및 SSL
- ❌ 모니터링 (Sentry, Logging)

---

## 📝 참고 문서

- **권한_체계_가이드.md** - 역할 기반 접근 제어 상세
- **구현_가이드_Phase1-6.md** - 구현 가이드
- **개발_가이드.md** - 기술 스택, API 명세
- **운영_가이드.md** - 운영 매뉴얼

---

**문서 버전**: 1.0
**최종 수정일**: 2025-01-13
**작성자**: Claude (Anthropic)
