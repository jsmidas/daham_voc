# Daham VOC 권한 체계 가이드

## 📋 개요

Daham VOC 시스템의 역할 기반 접근 제어(RBAC) 체계를 정의합니다.

---

## 🔐 권한 계층 구조

```
SUPER_ADMIN (시스템 최고 관리자)
├─ HQ_ADMIN (본사 부문 관리자)
│  ├─ GROUP_MANAGER (그룹 관리자 - 본사 도시락, 운반급식 등)
│  │  └─ SITE_MANAGER (사업장 관리자 - 복수 사업장)
│  │     └─ SITE_STAFF (사업장 담당자 - 단일 또는 복수 사업장)
│  └─ DELIVERY_DRIVER (배송 기사 - 복수 사업장)
└─ YEONGNAM_ADMIN (영남 부문 관리자)
   ├─ GROUP_MANAGER (그룹 관리자 - 영남 도시락, 운반급식 등)
   │  └─ SITE_MANAGER (사업장 관리자 - 복수 사업장)
   │     └─ SITE_STAFF (사업장 담당자 - 단일 또는 복수 사업장)
   └─ DELIVERY_DRIVER (배송 기사 - 복수 사업장)

CLIENT (고객사 담당자 - 사업장별 할당)
```

---

## 🎭 역할 정의

### 1. SUPER_ADMIN (시스템 최고 관리자)

**권한:**
- ✅ **전체 시스템 관리**
  - 모든 부문(본사/영남) 데이터 조회/수정
  - 모든 담당자 생성/수정/삭제
  - 시스템 설정 변경

- ✅ **담당자 관리**
  - 모든 역할의 사용자 추가/삭제
  - 역할 변경 (Role 수정)
  - 부문 변경 (Division 수정)

- ✅ **사업장 관리**
  - 모든 사업장 생성/수정/삭제
  - 사업장 그룹 생성/수정/삭제
  - 담당자 배정

- ✅ **데이터 접근**
  - 모든 사업장 VOC 조회/답변
  - 모든 배식 사진 조회/피드백
  - 모든 근태 기록 조회
  - 전체 통계 조회

**사용 사례:**
- 시스템 관리자
- CTO, 개발팀

---

### 2. HQ_ADMIN / YEONGNAM_ADMIN (부문별 관리자)

**권한:**
- ✅ **부문 데이터 관리**
  - 자신의 부문 데이터만 조회/수정
  - 자신의 부문 사업장 그룹 생성/삭제
  - 자신의 부문 사업장 생성/수정/삭제

- ✅ **그룹 관리**
  - 사업장 그룹 생성 (도시락, 운반급식, 행사 등)
  - 그룹에 사업장 추가/제거
  - 그룹 설정 변경 (마커 모양/색상 등)

- ✅ **담당자 관리 (제한적)**
  - 자신의 부문 GROUP_MANAGER 이하 역할 사용자 조회
  - **담당자 추가/삭제는 SUPER_ADMIN만 가능**

- ✅ **데이터 접근**
  - 자신의 부문 모든 사업장 VOC 조회/답변
  - 자신의 부문 배식 사진 조회/피드백
  - 자신의 부문 근태 기록 조회
  - 자신의 부문 통계 조회

**제한:**
- ❌ 다른 부문 데이터 접근 불가
- ❌ 담당자 추가/삭제 불가 (조회만 가능)
- ❌ 시스템 설정 변경 불가

**사용 사례:**
- 본사 영업팀장
- 영남지사 지사장

---

### 3. GROUP_MANAGER (그룹 관리자)

**권한:**
- ✅ **그룹 내 사업장 관리**
  - 자신이 관리하는 그룹의 사업장 생성/수정/삭제
  - 사업장별 담당자 배정 (SITE_MANAGER, SITE_STAFF)
  - 사업장 정보 수정 (주소, 연락처, 계약 정보 등)

- ✅ **그룹 설정**
  - 그룹 기본 정보 수정 (이름, 설명)
  - 마커 모양/색상 설정

- ✅ **데이터 접근**
  - 자신의 그룹 내 모든 사업장 VOC 조회/답변
  - 자신의 그룹 내 배식 사진 조회/피드백
  - 자신의 그룹 내 근태 기록 조회
  - 자신의 그룹 통계 조회

**제한:**
- ❌ 다른 그룹 데이터 접근 불가
- ❌ 사업장 그룹 생성/삭제 불가 (ADMIN만 가능)
- ❌ 담당자 추가/삭제 불가 (배정만 가능)

**사용 사례:**
- 도시락 사업부 팀장
- 운반급식 사업부 팀장

**DB 구조:**
```prisma
// StaffGroup 테이블 필요 (추후 추가)
model StaffGroup {
  id        String   @id @default(uuid())
  staffId   String
  groupId   String
  role      Role     // GROUP_MANAGER
  ...
}
```

---

### 4. SITE_MANAGER (사업장 관리자)

**권한:**
- ✅ **복수 사업장 관리**
  - 할당된 여러 사업장 정보 조회/수정
  - 사업장별 SITE_STAFF 배정
  - 사업장 운영 정보 관리

- ✅ **데이터 접근**
  - 할당된 사업장들의 VOC 조회/답변
  - 할당된 사업장들의 배식 사진 조회/피드백
  - 할당된 사업장들의 근태 기록 조회
  - 할당된 사업장들의 통계 조회

- ✅ **식단 관리**
  - 할당된 사업장 식단표 업로드
  - 주간 식단표 조회

**제한:**
- ❌ 사업장 생성/삭제 불가
- ❌ 할당되지 않은 사업장 접근 불가

**사용 사례:**
- 지역 책임자
- 여러 사업장을 관리하는 슈퍼바이저

**DB 구조:**
```prisma
// StaffSite 테이블 사용
model StaffSite {
  staffId   String
  siteId    String
  isPrimary Boolean  // 주 담당 여부
}
```

---

### 5. SITE_STAFF (사업장 담당자)

**권한:**
- ✅ **사업장 현장 업무**
  - 할당된 사업장 정보 조회
  - 배식/잔반 사진 업로드
  - VOC 입력/조회
  - 출퇴근 체크인/체크아웃
  - 식단표 조회

- ✅ **자신의 데이터 관리**
  - 자신이 업로드한 사진 수정/삭제
  - 자신이 작성한 VOC 수정
  - 자신의 근태 기록 조회

**제한:**
- ❌ 사업장 정보 수정 불가
- ❌ 다른 담당자 데이터 수정 불가
- ❌ 관리자 피드백 작성 불가 (조회만 가능)

**사용 사례:**
- 현장 담당자
- 조리사
- 배식 담당자

---

### 6. DELIVERY_DRIVER (배송 기사)

**권한:**
- ✅ **배송 업무**
  - 할당된 여러 사업장 정보 조회
  - 배식/잔반 사진 업로드 (복수 사업장)
  - VOC 입력/조회 (배송 관련)
  - 출퇴근 체크인/체크아웃

- ✅ **사진 관리**
  - 자신이 업로드한 사진만 수정/삭제

**제한:**
- ❌ 사업장 정보 수정 불가
- ❌ 식단표 업로드 불가
- ❌ 근태 관리 기능 제한적 (자신만 조회)

**사용 사례:**
- 배송 기사
- 순회 담당자

**차이점 (SITE_STAFF vs DELIVERY_DRIVER):**
- SITE_STAFF: 특정 사업장에 고정, 식단표 업로드 가능
- DELIVERY_DRIVER: 여러 사업장 순회, 사진 업로드와 VOC만 가능

---

### 7. CLIENT (고객사 담당자)

**권한:**
- ✅ **식수 관리**
  - 자신의 사업장 식수 인원 입력
  - 식수 입력 내역 조회

- ✅ **식단 조회**
  - 자신의 사업장 식단표 조회

- ✅ **VOC 작성**
  - VOC 입력/조회
  - 관리자 답변 조회

- ✅ **피드백**
  - 배식 사진에 평점/피드백 작성

**제한:**
- ❌ 사업장 정보 조회 불가 (자신의 연락처만)
- ❌ 사진 업로드 불가
- ❌ 근태 관련 기능 없음
- ❌ 통계 조회 불가

**사용 사례:**
- 고객사 총무팀
- 고객사 구내식당 담당자

**구분:**
- **Site.contactPerson1/2**: 단순 연락처 (시스템 미사용자)
- **CLIENT Role User**: 시스템 로그인 사용자 (식수 입력 등)

---

## 🗄️ 데이터베이스 구조

### User 모델
```prisma
model User {
  id       String    @id @default(uuid())
  email    String?
  password String
  name     String
  phone    String    @unique  // 로그인 ID
  role     Role      @default(SITE_STAFF)
  division Division?  // HQ_ADMIN/YEONGNAM_ADMIN에 필요
  ...
}
```

### Staff 모델
```prisma
model Staff {
  id           String      @id @default(uuid())
  userId       String      @unique
  employeeNo   String      @unique
  department   String?
  position     String?

  // Relations
  user         User        @relation(fields: [userId], references: [id])
  staffSites   StaffSite[]  // 담당 사업장들
}
```

### StaffSite (담당자-사업장 연결)
```prisma
model StaffSite {
  id          String      @id @default(uuid())
  staffId     String
  siteId      String
  isPrimary   Boolean     @default(false)  // 주 담당 여부
  assignedAt  DateTime    @default(now())

  staff       Staff       @relation(fields: [staffId], references: [id])
  site        Site        @relation(fields: [siteId], references: [id])

  @@unique([staffId, siteId])
}
```

---

## 🔒 권한 체크 로직

### 1. 사업장 접근 권한

```typescript
async function checkSiteAccess(userId: string, siteId: string): Promise<boolean> {
  const user = await prisma.user.findUnique({
    where: { id: userId },
    include: { staff: { include: { staffSites: true } } }
  });

  const site = await prisma.site.findUnique({ where: { id: siteId } });

  // SUPER_ADMIN: 모든 사업장 접근 가능
  if (user.role === 'SUPER_ADMIN') return true;

  // 부문 관리자: 자신의 부문만
  if (user.role === 'HQ_ADMIN') {
    return site.division === 'HQ';
  }

  if (user.role === 'YEONGNAM_ADMIN') {
    return site.division === 'YEONGNAM';
  }

  // GROUP_MANAGER: 자신의 그룹에 속한 사업장만
  if (user.role === 'GROUP_MANAGER') {
    // TODO: StaffGroup 테이블 조회
    return false;
  }

  // SITE_MANAGER, SITE_STAFF, DELIVERY_DRIVER: 할당된 사업장만
  const assigned = user.staff?.staffSites.some(ss => ss.siteId === siteId);
  return assigned || false;
}
```

### 2. 데이터 수정 권한

```typescript
async function canModifyData(userId: string, dataOwnerId: string, dataType: string): Promise<boolean> {
  const user = await prisma.user.findUnique({ where: { id: userId } });

  // 관리자는 모든 데이터 수정 가능
  if (['SUPER_ADMIN', 'HQ_ADMIN', 'YEONGNAM_ADMIN', 'GROUP_MANAGER', 'SITE_MANAGER'].includes(user.role)) {
    return true;
  }

  // 일반 사용자는 자신의 데이터만
  return userId === dataOwnerId;
}
```

---

## 📊 화면별 권한

### 담당자 관리 페이지

| 기능 | SUPER_ADMIN | HQ_ADMIN | YEONGNAM_ADMIN | GROUP_MANAGER | SITE_MANAGER | SITE_STAFF | CLIENT |
|------|-------------|----------|----------------|---------------|--------------|------------|--------|
| 담당자 목록 조회 | ✅ 전체 | ✅ 본사만 | ✅ 영남만 | ✅ 그룹만 | ✅ 사업장만 | ❌ | ❌ |
| 담당자 추가 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 담당자 삭제 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 담당자 정보 수정 | ✅ | ❌ | ❌ | ❌ | ❌ | ✅ 본인만 | ❌ |
| 사업장 배정 | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |

### 사업장 관리 페이지

| 기능 | SUPER_ADMIN | HQ_ADMIN | YEONGNAM_ADMIN | GROUP_MANAGER | SITE_MANAGER | SITE_STAFF | CLIENT |
|------|-------------|----------|----------------|---------------|--------------|------------|--------|
| 사업장 목록 조회 | ✅ 전체 | ✅ 본사만 | ✅ 영남만 | ✅ 그룹만 | ✅ 담당만 | ✅ 담당만 | ❌ |
| 사업장 생성 | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ |
| 사업장 수정 | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| 사업장 삭제 | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ |
| 담당자 배정 | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |

### VOC 관리 페이지

| 기능 | SUPER_ADMIN | HQ_ADMIN | YEONGNAM_ADMIN | GROUP_MANAGER | SITE_MANAGER | SITE_STAFF | CLIENT |
|------|-------------|----------|----------------|---------------|--------------|------------|--------|
| VOC 조회 | ✅ 전체 | ✅ 본사만 | ✅ 영남만 | ✅ 그룹만 | ✅ 담당만 | ✅ 담당만 | ✅ 본인만 |
| VOC 작성 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| VOC 답변 | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| VOC 삭제 | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |

---

## 🚀 구현 우선순위

### Phase 1: 기본 권한 (완료)
- ✅ SUPER_ADMIN
- ✅ HQ_ADMIN (기존)
- ✅ YEONGNAM_ADMIN (기존)
- ✅ STAFF (기존, SITE_STAFF로 변경)
- ✅ CLIENT

### Phase 2: 세분화된 권한 (다음 단계)
- ⏳ GROUP_MANAGER 추가
- ⏳ SITE_MANAGER 추가
- ⏳ DELIVERY_DRIVER 추가
- ⏳ StaffGroup 테이블 추가
- ⏳ 권한 미들웨어 개선

### Phase 3: 담당자 관리 UI (진행 예정)
- ⏳ 담당자 목록 페이지
- ⏳ 담당자 추가/수정 폼
- ⏳ 사업장 배정 UI
- ⏳ 계층 구조 시각화

---

## 📝 체크리스트

### schema.prisma 업데이트
- [x] Role Enum 업데이트
- [ ] StaffGroup 테이블 추가
- [ ] 마이그레이션 실행

### 백엔드 구현
- [ ] roleMiddleware 업데이트 (새 Role 추가)
- [ ] 권한 체크 유틸 함수 작성
- [ ] staff.service.ts 구현
- [ ] staff.controller.ts 구현
- [ ] staff.routes.ts 구현

### 프론트엔드 구현
- [ ] StaffListPage.tsx 구현
- [ ] StaffFormPage.tsx 구현
- [ ] 사업장 배정 컴포넌트
- [ ] 계층 구조 트리 컴포넌트

---

## 💡 FAQ

### Q1: 담당자와 고객사 담당자의 차이는?
**A:**
- **담당자(SITE_STAFF)**: 다함 직원, 현장 운영
- **고객사 담당자(CLIENT)**: 고객사 직원, 식수 입력/VOC

### Q2: contactPerson1/2는 언제 사용하나요?
**A:**
- 단순 연락처로만 사용
- 시스템 로그인이 필요한 경우 별도로 CLIENT User 생성

### Q3: DELIVERY_DRIVER와 SITE_STAFF의 차이는?
**A:**
- **SITE_STAFF**: 특정 사업장 고정, 모든 현장 업무
- **DELIVERY_DRIVER**: 여러 사업장 순회, 사진/VOC만

### Q4: GROUP_MANAGER는 언제 추가하나요?
**A:**
- Phase 2에서 구현
- StaffGroup 테이블 추가 필요

---

**문서 버전**: 1.0
**최종 수정일**: 2025-01-13
**작성자**: Claude (Anthropic)
