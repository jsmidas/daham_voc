# 구현 가이드 - 추가 기능 구현 (2025-01-13)

> **날짜**: 2025-01-13
> **구현 범위**: 식수 관리 강화, 근태 휴게시간 관리, 엑셀 다운로드 기능
> **관련 Phase**: Phase 3 (Backend), Phase 4 (Web), Phase 5 (Mobile)

---

## 📋 개요

### 구현 완료된 기능
1. ✅ **식수 조회/수정 웹 페이지** (Phase 4)
   - 날짜 범위 기반 조회
   - 가로 테이블 레이아웃 (날짜 × 식사 유형)
   - 인라인 수정/삭제

2. ✅ **근태 휴게시간 관리** (Phase 3, 4, 5)
   - Backend API 추가
   - Web 관리자 페이지 수정 기능
   - Mobile 휴게시간 입력 기능

3. ✅ **엑셀 다운로드 기능** (Phase 4, 5)
   - 식수 현황 엑셀 다운로드
   - 근태 현황 엑셀 다운로드

4. ✅ **모바일 식수 관리 화면** (Phase 5)
   - 식수 등록 (조/중/석/야)
   - 가로 테이블 레이아웃
   - 30일 이력 조회

---

## 🗂️ 파일 변경 사항

### Phase 3 (Backend) - 근태 휴게시간 관리

#### 1. 기존 파일 수정
```
backend/src/
├── services/attendance.service.ts          [수정] updateAttendance 함수 추가
├── controllers/attendance.controller.ts    [수정] updateAttendance 컨트롤러 추가
└── routes/attendance.routes.ts             [수정] PUT /:id 라우트 추가
```

**변경 내용:**
- `breakStartTime`, `breakEndTime`, `note` 필드 업데이트 기능 추가
- 관리자 권한만 수정 가능

---

### Phase 4 (Web Frontend) - 식수 조회/수정 및 엑셀 다운로드

#### 1. 신규 파일 생성
```
web/src/
├── pages/meal-count/MealCountListPage.tsx  [신규] 식수 조회/수정 페이지
└── router.tsx                              [수정] /meal-counts 라우트 추가
```

#### 2. 기존 파일 수정
```
web/src/
├── components/Layout/Sidebar.tsx           [수정] 식수 메뉴 분리
├── pages/attendance/AttendanceListPage.tsx [수정] 휴게시간 수정 모달 추가
└── api/attendance.api.ts                   [수정] updateAttendance 함수 추가
```

**주요 기능:**
- **식수 조회/수정 페이지**:
  - 날짜 범위 선택 (RangePicker, 기본: 현재 월)
  - 가로 테이블: 날짜(행) × 식사유형(열)
  - 각 셀: 인원수, 등록자, 수정/삭제 버튼
  - 일자별 합계 표시
  - 엑셀 다운로드

- **근태 관리 페이지**:
  - 휴게시작/종료 시간 컬럼 추가
  - TimePicker로 수정 모달
  - 엑셀 다운로드

---

### Phase 5 (Mobile App) - 식수 및 근태 기능 강화

#### 1. 신규 파일 생성
```
mobile/src/
├── screens/MealCountScreen.tsx             [신규] 식수 관리 화면
├── api/meal-count.api.ts                   [신규] 식수 API 클라이언트
└── navigation/MainNavigator.tsx            [수정] 식수 탭 추가
```

#### 2. 기존 파일 수정
```
mobile/src/
├── screens/AttendanceScreen.tsx            [수정] 휴게시간 수정 기능 추가
└── api/attendance.api.ts                   [수정] updateAttendance 함수 추가
```

**주요 기능:**
- **식수 관리 화면**:
  - 사업장 선택
  - 날짜 선택 (기본: 오늘)
  - 조/중/석/야 식사 유형별 인원 입력
  - 가로 테이블로 등록된 식수 표시
  - 30일 이력 스크롤 조회
  - 삭제 기능

- **근태 관리 화면**:
  - 휴게시간 표시 (미입력 시 '미입력')
  - 휴게시간 수정 모달 (HH:MM 형식)
  - 시간 형식 검증

---

## 📝 상세 구현 내용

### 1. 식수 조회/수정 페이지 (Web)

**파일**: `web/src/pages/meal-count/MealCountListPage.tsx`

**핵심 기능**:
```typescript
// 날짜 범위 상태
const [dateRange, setDateRange] = useState<[Dayjs, Dayjs]>([
  dayjs().startOf('month'),
  dayjs().endOf('month'),
]);

// 날짜별 데이터 그룹화
const groupByDate = (data: MealCount[]) => {
  const grouped: { [date: string]: { [mealType: string]: MealCount } } = {};
  data.forEach((item) => {
    if (!grouped[item.date]) grouped[item.date] = {};
    grouped[item.date][item.mealType] = item;
  });
  return grouped;
};

// 날짜 범위 내 모든 날짜 생성
const getAllDatesInRange = (startDate: Dayjs, endDate: Dayjs) => {
  const dates = [];
  let current = startDate.clone();
  while (current.isBefore(endDate) || current.isSame(endDate, 'day')) {
    dates.push(current.format('YYYY-MM-DD'));
    current = current.add(1, 'day');
  }
  return dates;
};

// 요일 한글 표시
const getDayOfWeek = (date: string) => {
  const days = ['일', '월', '화', '수', '목', '금', '토'];
  return days[dayjs(date).day()];
};
```

**테이블 구조**:
- **컬럼**: 날짜 | 조식 | 중식 | 석식 | 야식 | 합계
- **날짜 컬럼**: MM/DD + 요일(한글)
- **식사 컬럼**: 인원수 + 등록자명 + 수정/삭제 버튼
- **합계 컬럼**: 일자별 총 인원 수

**엑셀 다운로드**:
```typescript
const excelData = mealCounts.data.map((record: MealCount) => ({
  '날짜': dayjs(record.date).format('YYYY-MM-DD'),
  '식사 유형': getMealTypeLabel(record.mealType),
  '인원': record.count,
  '등록자': record.submitter?.name || '-',
  '등록시간': dayjs(record.submittedAt).format('YYYY-MM-DD HH:mm'),
  '상태': record.isLate ? '늦은 제출' : '정상',
  '비고': record.note || '-',
}));
```

---

### 2. 근태 휴게시간 관리

#### Backend (Phase 3)

**파일**: `backend/src/services/attendance.service.ts`

```typescript
export async function updateAttendance(
  id: string,
  data: {
    breakStartTime?: Date | null;
    breakEndTime?: Date | null;
    note?: string;
  }
): Promise<any> {
  const attendance = await prisma.attendance.findUnique({
    where: { id },
  });

  if (!attendance || attendance.deletedAt) {
    throw new Error('Attendance not found');
  }

  const updated = await prisma.attendance.update({
    where: { id },
    data: {
      breakStartTime: data.breakStartTime,
      breakEndTime: data.breakEndTime,
      note: data.note,
    },
    include: {
      user: { select: { id: true, name: true, email: true, role: true } },
      site: { select: { id: true, name: true, type: true } },
    },
  });

  await invalidateAttendanceCache(attendance.siteId);

  return updated;
}
```

**파일**: `backend/src/routes/attendance.routes.ts`

```typescript
// PUT /api/v1/attendances/:id - 출퇴근 정보 수정 (Admin only)
router.put(
  '/:id',
  authMiddleware,
  roleMiddleware(['SUPER_ADMIN', 'HQ_ADMIN', 'YEONGNAM_ADMIN']),
  attendanceController.updateAttendance
);
```

#### Web (Phase 4)

**파일**: `web/src/pages/attendance/AttendanceListPage.tsx`

**휴게시간 컬럼 추가**:
```typescript
{
  title: '휴게시작',
  dataIndex: 'breakStartTime',
  width: 120,
  render: (time?: string) => time ? dayjs(time).format('HH:mm') : '-',
},
{
  title: '휴게종료',
  dataIndex: 'breakEndTime',
  width: 120,
  render: (time?: string) => time ? dayjs(time).format('HH:mm') : '-',
},
```

**수정 모달**:
```typescript
<Modal title="휴게시간 수정" open={editModalVisible} onOk={handleSave}>
  <Form form={form} layout="vertical">
    <Form.Item label="휴게 시작 시간" name="breakStartTime">
      <TimePicker format="HH:mm" minuteStep={5} />
    </Form.Item>
    <Form.Item label="휴게 종료 시간" name="breakEndTime">
      <TimePicker format="HH:mm" minuteStep={5} />
    </Form.Item>
    <Form.Item label="비고" name="note">
      <Input.TextArea rows={3} />
    </Form.Item>
  </Form>
</Modal>
```

**엑셀 다운로드**:
```typescript
const excelData = attendances.data.map((record: any) => ({
  '직원명': record.user?.name || '-',
  '사업장': record.site?.name || '-',
  '체크인': dayjs(record.checkInTime).format('YYYY-MM-DD HH:mm'),
  '체크아웃': record.checkOutTime ? dayjs(record.checkOutTime).format('YYYY-MM-DD HH:mm') : '근무 중',
  '휴게시작': record.breakStartTime ? dayjs(record.breakStartTime).format('HH:mm') : '-',
  '휴게종료': record.breakEndTime ? dayjs(record.breakEndTime).format('HH:mm') : '-',
  '근무시간': calculateWorkHours(record.checkInTime, record.checkOutTime),
  '상태': getStatusText(record.status),
  '비고': record.note || '-',
}));
```

#### Mobile (Phase 5)

**파일**: `mobile/src/screens/AttendanceScreen.tsx`

**휴게시간 표시**:
```typescript
<View style={styles.timeRow}>
  <Text style={styles.timeLabel}>휴게 시간:</Text>
  <Text style={styles.timeValue}>
    {attendance.breakStartTime && attendance.breakEndTime
      ? `${formatTime(attendance.breakStartTime)} ~ ${formatTime(attendance.breakEndTime)}`
      : '미입력'}
  </Text>
</View>
```

**수정 모달**:
```typescript
<Modal visible={breakModalVisible} title="휴게시간 수정">
  <TextInput
    placeholder="시작 시간 (HH:MM)"
    value={breakStartTime}
    onChangeText={setBreakStartTime}
    keyboardType="numeric"
  />
  <TextInput
    placeholder="종료 시간 (HH:MM)"
    value={breakEndTime}
    onChangeText={setBreakEndTime}
    keyboardType="numeric"
  />
  <Button onPress={handleBreakTimeUpdate}>저장</Button>
</Modal>
```

---

### 3. 모바일 식수 관리 화면

**파일**: `mobile/src/screens/MealCountScreen.tsx`

**핵심 기능**:

1. **식수 등록**:
```typescript
const handleSubmit = async () => {
  const counts = [
    { mealType: 'BREAKFAST', count: breakfast },
    { mealType: 'LUNCH', count: lunch },
    { mealType: 'DINNER', count: dinner },
    { mealType: 'SUPPER', count: supper },
  ];

  for (const item of counts) {
    if (item.count > 0) {
      await createMealCount({
        siteId: selectedSiteId,
        date: selectedDate,
        mealType: item.mealType,
        count: item.count,
      });
    }
  }
};
```

2. **가로 테이블 레이아웃**:
```typescript
{/* 테이블 헤더 */}
<View style={styles.horizontalTableHeader}>
  {MEAL_TYPES.map((meal) => (
    <View key={meal.value} style={styles.horizontalHeaderCell}>
      <Text>{meal.icon}</Text>
      <Text>{meal.label}</Text>
    </View>
  ))}
</View>

{/* 테이블 데이터 */}
<View style={styles.horizontalDataRow}>
  {MEAL_TYPES.map((meal) => {
    const data = mealMap[meal.value];
    return (
      <View key={meal.value} style={styles.horizontalDataCell}>
        {data ? (
          <>
            <Text>{data.count}명</Text>
            {data.isLate && <Text>⚠️</Text>}
          </>
        ) : (
          <Text>-</Text>
        )}
      </View>
    );
  })}
</View>
```

3. **30일 이력 조회**:
```typescript
const getLast30Days = () => {
  const dates = [];
  for (let i = 0; i < 30; i++) {
    dates.push(dayjs().subtract(i, 'day').format('YYYY-MM-DD'));
  }
  return dates;
};

const { data: mealCounts } = useQuery({
  queryKey: ['meal-counts', selectedSiteId, dateRange[0], dateRange[1]],
  queryFn: () => getMealCountsByRange(
    selectedSiteId,
    dateRange[0], // 30일 전
    dateRange[1]  // 오늘
  ),
});

// 날짜별 섹션으로 표시
{allDates.map((date) => (
  <View key={date}>
    <Text style={styles.dateHeader}>
      {dayjs(date).format('YYYY-MM-DD (ddd)')}
    </Text>
    {/* 해당 날짜의 식수 데이터 테이블 */}
  </View>
))}
```

---

## 🔧 npm 패키지 설치

### Web (xlsx 라이브러리)
```bash
cd web
npm install xlsx
```

---

## 📊 구현 통계

### 추가/수정된 파일

| 구분 | 파일 수 | 주요 파일 |
|------|---------|-----------|
| Backend (Phase 3) | 3개 수정 | attendance.service.ts, controller, routes |
| Web (Phase 4) | 1개 신규, 4개 수정 | MealCountListPage (신규), Attendance 페이지, API |
| Mobile (Phase 5) | 2개 신규, 2개 수정 | MealCountScreen (신규), meal-count.api (신규) |
| **총계** | **3개 신규, 9개 수정** | **총 12개 파일** |

### 추가 코드 라인
- **Backend**: ~100 라인
- **Web**: ~600 라인
- **Mobile**: ~800 라인
- **총계**: ~1,500 라인

---

## ✅ 테스트 체크리스트

### Web 식수 조회/수정 페이지
- [x] 사업장 선택 시 데이터 조회
- [x] 날짜 범위 변경 시 데이터 재조회
- [x] 가로 테이블에 날짜별 식수 표시
- [x] 각 셀에 인원수, 등록자명, 버튼 표시
- [x] 식수 수정 기능
- [x] 식수 삭제 기능
- [x] 식수 등록 시 날짜 선택 가능
- [x] 엑셀 다운로드 기능
- [x] 요일 한글 표시 (월화수목금토일)

### Web 근태 관리 페이지
- [x] 휴게시작/종료 컬럼 표시
- [x] 수정 버튼 클릭 시 모달 오픈
- [x] TimePicker로 시간 선택
- [x] 저장 후 데이터 갱신
- [x] 엑셀 다운로드에 휴게시간 포함

### Mobile 식수 관리 화면
- [x] 사업장 선택
- [x] 날짜 선택
- [x] 조/중/석/야 인원 입력
- [x] 등록 버튼으로 저장
- [x] 가로 테이블로 등록된 식수 표시
- [x] 30일 이력 스크롤 조회
- [x] 삭제 기능

### Mobile 근태 관리 화면
- [x] 휴게시간 표시
- [x] 수정 버튼 클릭 시 모달 오픈
- [x] HH:MM 형식으로 입력
- [x] 형식 검증
- [x] 저장 후 데이터 갱신

---

## 🎯 향후 개선 사항

### 성능 최적화
- [ ] 식수 테이블 가상 스크롤 적용 (대량 데이터 시)
- [ ] 엑셀 다운로드 워커 스레드 사용 (대용량 파일)

### 기능 추가
- [ ] 식수 일괄 등록 (여러 날짜 동시 등록)
- [ ] 식수 복사 기능 (이전 날짜 데이터 복사)
- [ ] 근태 일괄 수정 (여러 직원 동시 수정)

### UX 개선
- [ ] 식수 테이블 헤더 고정 (스크롤 시)
- [ ] 모바일 식수 등록 시 마지막 입력 값 자동 채우기
- [ ] 근태 휴게시간 자동 계산 (점심시간 등)

---

## 📅 구현 완료일
**2025-01-13**

---

## 🔗 관련 문서
- [구현_가이드_Phase3.md](./구현_가이드_Phase3.md) - Backend 근태 관리
- [구현_가이드_Phase4.md](./구현_가이드_Phase4.md) - Web Frontend
- [구현_가이드_Phase5.md](./구현_가이드_Phase5.md) - Mobile App

======================================================================
======================================================================

● 현재 프로젝트 상태를 보면 다음과 같은 작업들을 고려할 수     
  있습니다:

  🎯 우선순위별 다음 작업

  📱 높음: 모바일 앱 핵심 기능 완성

  1. 배식사진 관리
    - 카메라로 사진 촬영 (expo-camera)
    - 배식/잔반/시설 사진 업로드
    - GPS 좌표 기록 및 Geofencing
    - 사진 목록 조회 및 삭제
  2. 식단 조회 기능
    - 사업장별 주간 식단표 조회
    - 이미지 뷰어
    - 날짜별 필터링
  3. VOC 기능 보완
    - 이미지 첨부 (최대 6개)
    - 내 VOC 목록 조회
    - 답변 알림

  🌐 중간: 웹 관리자 기능 강화

  1. 대시보드 고도화
    - 사업장별 상세 통계
    - 트렌드 그래프 (Chart.js)
    - 담당자별 평점 통계
  2. 배식사진 관리 개선
    - 일괄 승인/반려 기능
    - 사진 필터링 강화
    - 엑셀 다운로드
  3. 알림 시스템
    - 늦은 식수 제출 알림
    - VOC 미처리 알림
    - 비정상 근태 알림

  🚀 장기: 인프라 및 배포 (Phase 6)

  1. Docker 컨테이너화
    - Backend Dockerfile
    - Web Dockerfile
    - docker-compose.yml
  2. CI/CD 파이프라인
    - GitHub Actions 설정
    - 자동 테스트 실행
    - 자동 배포
  3. 클라우드 배포
    - GCP Cloud Run 배포
    - PostgreSQL Cloud SQL
    - Redis Memorystore
    - GCS 이미지 저장소

  🔧 기술 부채 해소

  1. 테스트 코드
    - Backend API 단위 테스트
    - E2E 테스트
    - 통합 테스트
  2. 성능 최적화
    - 쿼리 최적화
    - 이미지 lazy loading
    - Redis 캐싱 확대
  3. 보안 강화
    - Rate limiting
    - Input validation 강화
    - SQL Injection 방어

  ---
  💡 제안하는 다음 작업 순서

  가장 실용적인 순서는:

  1. 모바일 배식사진 관리 (1-2일)
    - 실제 사용자가 가장 필요로 하는 기능
    - 기존 Backend API 활용 가능
  2. 모바일 식단 조회 (1일)
    - 사용자 편의성 향상
    - 이미 Backend API 구현됨
  3. 웹 대시보드 고도화 (2-3일)
    - 관리자 의사결정 지원
    - Chart.js로 시각화
  4. Docker & 배포 (3-5일)
    - 프로덕션 환경 준비
    - Phase 6 완성