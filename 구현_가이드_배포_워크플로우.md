# Daham VOC - 배포 및 개발 워크플로우 가이드

> **📌 목적**: 로컬 개발부터 프로덕션 배포까지의 전체 워크플로우를 안내합니다.

---

## 📋 목차
1. [개발 환경 구조](#1-개발-환경-구조)
2. [로컬 vs 프로덕션 환경 설정](#2-로컬-vs-프로덕션-환경-설정)
3. [개발 워크플로우](#3-개발-워크플로우)
4. [프로덕션 배포 프로세스](#4-프로덕션-배포-프로세스)
5. [데이터베이스 관리](#5-데이터베이스-관리)
6. [트러블슈팅](#6-트러블슈팅)

---

## 1. 개발 환경 구조

### 1.1 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────┐
│ 🏠 로컬 개발 환경 (개발자 PC)                              │
│                                                           │
│  ┌──────────────┐       ┌──────────────┐                │
│  │ Web (5173)   │──────▶│ Backend(3000)│                │
│  │ Vite Dev     │       │  Nodemon     │                │
│  └──────────────┘       └──────┬───────┘                │
│                                 │                         │
│                                 ▼                         │
│                         ┌──────────────┐                 │
│                         │ PostgreSQL   │                 │
│                         │ (개발/테스트용)│                │
│                         └──────────────┘                 │
│                                                           │
│  용도: 새 기능 개발, 버그 수정, 테스트                      │
└─────────────────────────────────────────────────────────┘

                              Git Push
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────┐
│ ☁️  프로덕션 서버 (GCP VM - 165.246.44.4)                  │
│                                                           │
│  ┌──────────────┐       ┌──────────────┐                │
│  │ Nginx (80)   │──────▶│ Backend(3000)│                │
│  │ HTTPS (443)  │       │  PM2         │                │
│  └──────────────┘       └──────┬───────┘                │
│                                 │                         │
│                                 ▼                         │
│                         ┌──────────────┐                 │
│                         │ PostgreSQL   │                 │
│                         │ (실제 데이터) │                 │
│                         └──────────────┘                 │
│                                                           │
│  용도: 실제 서비스, 실제 데이터 입력/관리                    │
└─────────────────────────────────────────────────────────┘
```

### 1.2 환경별 URL

| 환경 | 웹 관리자 | 백엔드 API |
|------|-----------|-----------|
| **로컬** | http://localhost:5173 | http://localhost:3000/api/v1 |
| **프로덕션** | https://dahamvoc.co.kr | https://api.dahamvoc.co.kr/api/v1 |

---

## 2. 로컬 vs 프로덕션 환경 설정

### 2.1 백엔드 환경 변수

#### 로컬 개발 환경 (backend/.env)

```env
# Environment
NODE_ENV=development
PORT=3000

# Database (로컬 PostgreSQL)
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/daham_voc
MONGODB_URI=mongodb://localhost:27017/daham_voc
REDIS_URL=redis://localhost:6379

# JWT
JWT_SECRET=daham_voc_secret_key_2025_development_only
JWT_EXPIRES_IN=7d

# GCP Storage
GCP_PROJECT_ID=your-project-id
GCP_BUCKET_NAME=daham-voc-images
GCP_KEY_FILE=./config/gcp-service-account-key.json

# Image Upload
MAX_IMAGE_SIZE=10485760
ALLOWED_IMAGE_TYPES=image/jpeg,image/png,image/webp

# CORS
CORS_ORIGIN=http://localhost:5173,http://localhost:8081

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100
```

#### 프로덕션 환경 (서버의 backend/.env)

```env
# Environment
NODE_ENV=production
PORT=3000

# Database (프로덕션 PostgreSQL - 같은 서버 내부)
DATABASE_URL=postgresql://daham_user:cc956697!!@localhost:5432/daham_voc

# JWT
JWT_SECRET=daham_voc_super_secret_key_2025
JWT_EXPIRES_IN=7d

# GCP Storage
GCP_PROJECT_ID=daham-food
GCP_BUCKET_NAME=daham-voc-images
GCP_KEY_FILE=./config/gcp-service-account-key.json

# Image Upload
MAX_IMAGE_SIZE=10485760
ALLOWED_IMAGE_TYPES=image/jpeg,image/png,image/webp

# CORS
CORS_ORIGIN=https://dahamvoc.co.kr
```

**⚠️ 중요:** 로컬에서는 절대 프로덕션 DB에 직접 연결하지 마세요!

---

### 2.2 프론트엔드 환경 변수

#### 로컬 개발 환경 (web/.env)

```env
# API (로컬 백엔드 사용)
VITE_API_BASE_URL=/api/v1

# Kakao Map API Keys
VITE_KAKAO_MAP_APP_KEY=c49d3caee184645323027f84b59a9f8f
VITE_KAKAO_REST_API_KEY=2ec48bfd86a549a69da630e18d685008
```

#### Vite Proxy 설정 (web/vite.config.ts)

```typescript
export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'https://api.dahamvoc.co.kr',  // 프로덕션 API 사용
        changeOrigin: true,
        secure: false,
      },
    },
  },
})
```

**로컬 백엔드 테스트 시:**
```typescript
proxy: {
  '/api': {
    target: 'http://localhost:3000',  // 로컬 백엔드
    changeOrigin: true,
  },
}
```

---

## 3. 개발 워크플로우

### 3.1 일반적인 개발 프로세스

```mermaid
graph TD
    A[새 기능 요구사항] --> B[로컬 개발 환경에서 개발]
    B --> C[로컬 DB로 테스트]
    C --> D{테스트 통과?}
    D -->|No| B
    D -->|Yes| E[Git Commit & Push]
    E --> F[프로덕션 서버 배포]
    F --> G[실제 서비스 반영]
```

### 3.2 단계별 상세 가이드

#### Step 1: 로컬 개발 환경 실행

```bash
# 1. 백엔드 실행 (터미널 1)
cd backend
npm run dev:clean
# ✅ http://localhost:3000 실행 중

# 2. 웹 프론트엔드 실행 (터미널 2)
cd web
npm run dev
# ✅ http://localhost:5173 실행 중
```

#### Step 2: 기능 개발 및 테스트

**예시: Validator 필드 추가**

```typescript
// backend/src/validators/site.validator.ts
export const createSiteSchema = Joi.object({
  name: Joi.string().required(),
  // ... 기존 필드

  // 새로운 필드 추가
  mealTypes: Joi.array()
    .items(Joi.string().valid('BREAKFAST', 'LUNCH', 'DINNER', 'SNACK'))
    .optional(),
  pricePerMeal: Joi.number().min(0).optional(),
  deliveryRoute: Joi.string().max(100).optional(),
  contractStartDate: Joi.date().iso().optional(),
  contractEndDate: Joi.date().iso().optional(),
  sortOrder: Joi.number().min(0).optional(),
});
```

**로컬에서 테스트:**
1. 웹 관리자 접속 (http://localhost:5173)
2. 사업장 등록 시도
3. 422 에러 없이 정상 등록되는지 확인

#### Step 3: Git Commit & Push

```bash
# 1. 변경사항 확인
git status

# 2. 변경된 파일만 Stage
git add backend/src/validators/site.validator.ts

# 3. Commit (명확한 메시지 작성)
git commit -m "fix: Add missing fields to site validator

- Add mealTypes, pricePerMeal, deliveryRoute fields
- Add contractStartDate, contractEndDate, sortOrder fields
- Fix 422 validation error on site registration"

# 4. Push to GitHub
git push
```

**Commit 메시지 규칙:**
- `feat:` 새 기능 추가
- `fix:` 버그 수정
- `refactor:` 코드 리팩토링
- `docs:` 문서 수정
- `chore:` 설정 변경

#### Step 4: 프로덕션 배포

```bash
# 1. SSH로 프로덕션 서버 접속
ssh root@165.246.44.4

# 2. 프로젝트 디렉토리로 이동
cd ~/daham_voc

# 3. Git Pull (최신 코드 가져오기)
git pull

# 4. Backend 빌드
cd backend
npm install  # 새로운 패키지가 추가된 경우만
npm run build

# 5. PM2로 서버 재시작
pm2 restart daham-voc-api

# 6. 배포 확인
pm2 status
pm2 logs daham-voc-api --lines 20

# 7. SSH 종료
exit
```

#### Step 5: 배포 검증

```bash
# API Health Check
curl https://api.dahamvoc.co.kr/health

# 웹 관리자 접속
# https://dahamvoc.co.kr
# 실제 데이터로 기능 테스트
```

---

## 4. 프로덕션 배포 프로세스

### 4.1 배포 유형별 가이드

#### 📝 Schema 변경이 없는 경우 (Validator, 비즈니스 로직 등)

```bash
ssh root@165.246.44.4
cd ~/daham_voc
git pull
cd backend
npm run build
pm2 restart daham-voc-api
exit
```

**소요 시간:** ~2분
**리스크:** 낮음
**다운타임:** 없음 (PM2가 자동으로 무중단 재시작)

---

#### 🗄️ Schema 변경이 있는 경우 (DB 테이블 구조 변경)

```bash
ssh root@165.246.44.4
cd ~/daham_voc/backend

# 1. 데이터베이스 백업 (중요!)
pg_dump -U daham_user -h localhost daham_voc > ~/backups/daham_voc_$(date +%Y%m%d_%H%M%S).sql

# 2. Git Pull
cd ~/daham_voc
git pull

# 3. Prisma 마이그레이션 실행
cd backend
npx prisma migrate deploy

# 4. 빌드 및 재시작
npm run build
pm2 restart daham-voc-api

# 5. 마이그레이션 확인
pm2 logs daham-voc-api --lines 50
```

**소요 시간:** ~5분
**리스크:** 중간
**다운타임:** 1-2초 (재시작 시)

---

#### 🎨 프론트엔드 변경이 있는 경우

**방법 1: 프로덕션 웹 서버가 있는 경우**
```bash
ssh root@165.246.44.4
cd ~/daham_voc/web
git pull
npm install  # 패키지 변경이 있다면
npm run build
pm2 restart daham-frontend
```

**방법 2: 프로덕션 웹이 없는 경우 (현재)**
- 로컬에서 개발 → Git push만 하면 끝
- 프론트엔드는 Vite proxy를 통해 프로덕션 API 사용

---

### 4.2 자동화 배포 스크립트

#### deploy.sh (프로덕션 서버에 생성)

```bash
#!/bin/bash
# ~/daham_voc/deploy.sh

echo "🚀 Daham VOC 배포 시작..."

cd ~/daham_voc

# Git Pull
echo "📥 Git Pull..."
git pull origin main

# Backend 배포
echo "🔧 백엔드 업데이트..."
cd backend
npm install
npm run build
pm2 restart daham-voc-api

# 상태 확인
echo "✅ 배포 완료!"
pm2 status
pm2 logs daham-voc-api --lines 10
```

**사용 방법:**
```bash
ssh root@165.246.44.4
~/daham_voc/deploy.sh
```

---

## 5. 데이터베이스 관리

### 5.1 로컬 DB vs 프로덕션 DB

| 구분 | 로컬 DB | 프로덕션 DB |
|------|---------|------------|
| **용도** | 개발, 테스트 | 실제 서비스 |
| **데이터** | 테스트 데이터 | 실제 사용자 데이터 |
| **접속 방법** | 직접 접속 | SSH 터널 또는 서버 내부에서만 |
| **백업** | 선택사항 | 필수 (매일 자동 백업) |
| **실수 영향** | 없음 | 심각 |

### 5.2 프로덕션 DB 접속 방법

#### 방법 1: SSH로 서버 접속 후 psql 사용 (권장)

```bash
# 1. SSH 접속
ssh root@165.246.44.4

# 2. PostgreSQL 접속
psql -U daham_user -d daham_voc

# 3. 쿼리 실행
daham_voc=# SELECT COUNT(*) FROM "Site";
daham_voc=# \dt  -- 테이블 목록
daham_voc=# \q   -- 종료
```

#### 방법 2: SSH 터널링 (고급)

```bash
# 로컬에서 SSH 터널 생성
ssh -L 5433:localhost:5432 root@165.246.44.4

# 다른 터미널에서 로컬 포트로 접속
psql -h localhost -p 5433 -U daham_user -d daham_voc
```

**⚠️ 주의:** 프로덕션 DB에 직접 연결할 때는 항상 조심하세요!

### 5.3 데이터베이스 백업

#### 자동 백업 설정 (프로덕션 서버)

```bash
# 백업 스크립트 생성
nano ~/backup-db.sh
```

```bash
#!/bin/bash
BACKUP_DIR=~/backups
mkdir -p $BACKUP_DIR
DATE=$(date +%Y%m%d_%H%M%S)
PGPASSWORD=cc956697!! pg_dump -U daham_user -h localhost daham_voc > $BACKUP_DIR/daham_voc_$DATE.sql
echo "✅ 백업 완료: $BACKUP_DIR/daham_voc_$DATE.sql"

# 7일 이상 된 백업 삭제
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
```

```bash
# 실행 권한 부여
chmod +x ~/backup-db.sh

# Cron 설정 (매일 새벽 2시)
crontab -e
# 추가:
0 2 * * * ~/backup-db.sh
```

#### 수동 백업

```bash
# 즉시 백업
ssh root@165.246.44.4
~/backup-db.sh
```

### 5.4 Schema 변경 시 마이그레이션

#### Prisma 마이그레이션 생성 (로컬)

```bash
# 1. Prisma Schema 수정
# prisma/schema.prisma

# 2. 마이그레이션 생성
npx prisma migrate dev --name add_new_field

# 3. Git Commit
git add prisma/
git commit -m "feat: Add new field to Site model"
git push
```

#### 프로덕션 적용

```bash
ssh root@165.246.44.4
cd ~/daham_voc/backend

# 백업 먼저!
pg_dump -U daham_user daham_voc > ~/backups/before_migration_$(date +%Y%m%d).sql

# 마이그레이션 적용
npx prisma migrate deploy

# 재시작
pm2 restart daham-voc-api
```

---

## 6. 트러블슈팅

### 6.1 배포 후 422 Validation 에러

**증상:**
```
POST /api/v1/sites 422 (Unprocessable Entity)
```

**원인:**
- Validator에 필드가 누락됨
- 프론트엔드에서 보내는 데이터와 validator 불일치

**해결:**
```bash
# 1. 로컬에서 validator 확인
# backend/src/validators/site.validator.ts

# 2. 필드 추가
export const createSiteSchema = Joi.object({
  // 누락된 필드 추가
});

# 3. 배포
git add backend/src/validators/site.validator.ts
git commit -m "fix: Add missing fields to validator"
git push

# 4. 프로덕션 배포
ssh root@165.246.44.4
cd ~/daham_voc && git pull
cd backend && npm run build && pm2 restart daham-voc-api
```

---

### 6.2 PM2 프로세스가 계속 재시작됨

**증상:**
```bash
pm2 status
# daham-voc-api  │ errored  │ 50  │
```

**원인 확인:**
```bash
pm2 logs daham-voc-api --lines 50
```

**일반적인 원인:**
1. DATABASE_URL 오류
2. 환경 변수 누락
3. TypeScript 빌드 오류

**해결:**
```bash
# 1. 환경 변수 확인
cat ~/daham_voc/backend/.env

# 2. 빌드 오류 확인
cd ~/daham_voc/backend
npm run build

# 3. 수동 실행으로 에러 확인
node dist/server.js

# 4. 정상이면 PM2 재시작
pm2 delete daham-voc-api
pm2 start dist/server.js --name daham-voc-api
```

---

### 6.3 PostgreSQL 연결 실패

**증상:**
```
Can't reach database server at `localhost:5432`
```

**해결:**
```bash
# PostgreSQL 상태 확인
sudo systemctl status postgresql

# 실행 중이 아니면 시작
sudo systemctl start postgresql

# 자동 시작 설정
sudo systemctl enable postgresql
```

---

### 6.4 Git Pull 충돌 발생

**증상:**
```
error: Your local changes to the following files would be overwritten by merge
```

**해결:**
```bash
# 로컬 변경사항 확인
git status

# 방법 1: 로컬 변경사항 버리기 (서버에서만!)
git reset --hard HEAD
git pull

# 방법 2: 로컬 변경사항 보관
git stash
git pull
git stash pop  # 필요하다면
```

---

### 6.5 Kakao API 401 Unauthorized

**증상:**
```
GET https://dapi.kakao.com/v2/local/search/address.json 401 (Unauthorized)
```

**원인:**
- JavaScript 키로 REST API 호출
- 플랫폼 도메인 미등록

**해결:**
```bash
# 1. .env 파일 확인
cat web/.env
# VITE_KAKAO_REST_API_KEY가 있는지 확인

# 2. Kakao Developers Console에서 플랫폼 등록
# https://developers.kakao.com/
# - Web: http://localhost:5173, https://dahamvoc.co.kr
# - Android: 패키지명 등록
```

---

## 7. 체크리스트

### 7.1 개발 시작 전

- [ ] 로컬 백엔드 실행 중
- [ ] 로컬 PostgreSQL 실행 중
- [ ] backend/.env가 로컬 DB 사용 중
- [ ] Git branch가 main인지 확인

### 7.2 배포 전

- [ ] 로컬에서 기능 테스트 완료
- [ ] Validator 변경사항 확인
- [ ] Migration 필요 여부 확인
- [ ] Git commit 메시지 명확히 작성
- [ ] Git push 완료

### 7.3 배포 후

- [ ] PM2 상태 정상 (online)
- [ ] PM2 로그 에러 없음
- [ ] API Health Check 정상
- [ ] 웹 관리자에서 기능 동작 확인
- [ ] 사용자에게 변경사항 공지 (필요시)

---

## 8. 주요 명령어 요약

### Git 관련

```bash
git status                    # 변경사항 확인
git add .                     # 모든 변경사항 Stage
git commit -m "message"       # Commit
git push                      # Push to GitHub
git pull                      # 최신 코드 가져오기
git log --oneline -10         # 최근 10개 커밋 확인
```

### 로컬 개발

```bash
# 백엔드
cd backend
npm run dev:clean             # 개발 서버 시작
npm run build                 # TypeScript 빌드
npx prisma studio             # Prisma DB GUI

# 프론트엔드
cd web
npm run dev                   # Vite 개발 서버
npm run build                 # 프로덕션 빌드
```

### 프로덕션 배포

```bash
ssh root@165.246.44.4         # SSH 접속
cd ~/daham_voc && git pull    # 코드 업데이트
cd backend && npm run build   # 빌드
pm2 restart daham-voc-api     # 재시작
pm2 status                    # 상태 확인
pm2 logs daham-voc-api        # 로그 확인
exit                          # SSH 종료
```

### 데이터베이스

```bash
# 로컬
psql -U postgres -d daham_voc

# 프로덕션 (SSH 접속 후)
psql -U daham_user -d daham_voc

# 백업
pg_dump -U daham_user daham_voc > backup.sql

# 복원
psql -U daham_user daham_voc < backup.sql
```

---

## 9. 참고 자료

### 내부 문서
- [DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md) - GCP VM 배포 가이드
- [개발_가이드.md](./개발_가이드.md) - 기본 개발 가이드
- [운영_가이드.md](./운영_가이드.md) - 시스템 운영 가이드

### 외부 링크
- [Git 기초 사용법](https://git-scm.com/book/ko/v2)
- [PM2 공식 문서](https://pm2.keymetrics.io/docs/usage/quick-start/)
- [Prisma 마이그레이션](https://www.prisma.io/docs/concepts/components/prisma-migrate)
- [PostgreSQL 백업 가이드](https://www.postgresql.org/docs/current/backup.html)

---

**마지막 업데이트:** 2025-10-18
**작성자:** Claude Code Assistant
